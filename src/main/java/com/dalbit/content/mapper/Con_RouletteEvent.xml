<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.content.dao.Con_RouletteEventDao" >

    <select id="callRouletteRate" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.content.vo.procedure.P_RouletteRateVo">
        call rd_admin.sp_admin_event_roulette_rate_select(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callEditRouletteRate" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.content.vo.procedure.P_RouletteRateVo">
        call rd_admin.sp_admin_event_roulette_rate_edit(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <sql id="applyListCondition">
        <if test='txt_search != null and txt_search != ""'>
            <choose>
                <when test='searchType == "1"'>
                    AND evtApply.mem_no like  concat ('%', #{txt_search}, '%')
                </when>
                <when test='searchType == "2"'>
                    AND (
                        member.mem_userid like concat ('%', #{txt_search}, '%')
                        or outMember.mem_userid like concat ('%', #{txt_search}, '%')
                    )
                </when>
                <when test='searchType == "3"'>
                    AND (
                        member.mem_nick like concat ('%', #{txt_search}, '%')
                        or outMember.mem_nick like concat ('%', #{txt_search}, '%')
                    )
                </when>
                <otherwise>
                    and (
                        evtApply.mem_no like  concat ('%', #{txt_search}, '%')
                        or member.mem_userid like concat ('%', #{txt_search}, '%')
                        or outMember.mem_userid like concat ('%', #{txt_search}, '%')
                        or member.mem_nick like concat ('%', #{txt_search}, '%')
                        or outMember.mem_nick like concat ('%', #{txt_search}, '%')
                    )
                </otherwise>
            </choose>
        </if>

        <if test='startDate != null and startDate != ""'>
            and DATE_FORMAT(evtApply.apply_date, '%Y-%m-%d') >= DATE_FORMAT(#{startDate}, '%Y-%m-%d')

        </if>
        <if test='endDate != null and endDate != ""'>
            and DATE_FORMAT(#{endDate}, '%Y-%m-%d') >= DATE_FORMAT(evtApply.apply_date, '%Y-%m-%d')
        </if>

        <if test='winType == 1'>
            and evtApply.item_no in ('1', '2', '3')
        </if>
        <if test='winType == 2'>
            and evtApply.item_no not in ('1', '2', '3')
        </if>
    </sql>

    <select id="selectRouletteApplyList" parameterType="com.dalbit.content.vo.RouletteApplyVo" resultType="com.dalbit.content.vo.RouletteApplyVo">
        /* Con_RouletteEvent.xml - selectRouletteApplyList */
        select
            evtApply.mem_no
            , date_format(evtApply.apply_date, '%Y.%m.%d %H:%i:%s') apply_date
            , evtApply.item_no
            , date_format(win.win_date, '%Y.%m.%d %H:%i:%s') win_date
            , date_format(win.last_upd_date, '%Y.%m.%d %H:%i:%s') last_upd_date
            , win.phone
            , profile.image_profile
            , ifnull(member.mem_nick, outMember.mem_nick) mem_nick
            , ifnull(member.mem_userid, outMember.mem_userid) mem_userid
            , ifnull(member.mem_sex, outMember.mem_sex) mem_sex
        from rd_data.tb_event_coupon_member_apply evtApply
            left join rd_data.tb_event_coupon_winning win on evtApply.mem_no = win.mem_no and evtApply.apply_date = win.win_date and evtApply.item_no = win.item_no
            left join rd_data.tb_member_basic member on evtApply.mem_no = member.mem_no
            left join rd_data.tb_member_withdrawal_bak outMember on evtApply.mem_no = outMember.mem_no
            left join rd_data.tb_member_profile profile on evtApply.mem_no = profile.mem_no

        where 1=1
            <include refid="applyListCondition" />
        order by evtApply.item_no asc
        limit #{pageStart}, #{pageCnt}
    </select>

    <select id="selectRouletteApplyCnt" parameterType="com.dalbit.content.vo.RouletteApplyVo" resultType="int">
        /* Con_RouletteEvent.xml - selectRouletteApplyCnt */
        select
            count(*)
        from rd_data.tb_event_coupon_member_apply evtApply
            left join rd_data.tb_event_coupon_winning win on evtApply.mem_no = win.mem_no and evtApply.apply_date = win.win_date and evtApply.item_no = win.item_no
            left join rd_data.tb_member_basic member on evtApply.mem_no = member.mem_no
            left join rd_data.tb_member_withdrawal_bak outMember on evtApply.mem_no = outMember.mem_no
        where 1=1
            <include refid="applyListCondition" />
    </select>

    <select id="selectRouletteWeekCalendarList" parameterType="com.dalbit.content.vo.RouletteCalendarVo" resultType="com.dalbit.content.vo.RouletteCalendarVo">
        /* Con_RouletteEvent.xml - selectRouletteWeekCalendarList */
        select
            (select count(distinct mem_no)
                from rd_data.stat_member_login_day
                where date_format(#{search_startDate}, '%Y-%m-%d') <![CDATA[<=]]> date_format(the_date, '%Y-%m-%d')
                and date_format(the_date, '%Y-%m-%d') <![CDATA[<=]]> date_format(#{search_endDate}, '%Y-%m-%d')
            ) loginCnt
            , itemCnt
            , itemNo1
            , itemNo2
            , itemNo3
            , itemNo4
            , itemNo5
            , itemNo6
            , itemNo7
            , itemNo8
            , (select count(distinct mem_no)
                from rd_data.tb_event_coupon_member_apply apply
                where date_format(#{search_startDate}, '%Y-%m-%d') <![CDATA[<=]]> date_format(apply.apply_date, '%Y-%m-%d')
                and date_format(apply.apply_date, '%Y-%m-%d') <![CDATA[<=]]> date_format(#{search_endDate}, '%Y-%m-%d')) joinCnt
            , (select count(*)
                from rd_data.tb_event_coupon_member_apply apply
                left join rd_data.tb_member_basic mem on apply.mem_no = mem.mem_no
                left join rd_data.tb_member_withdrawal_bak withdrawal on apply.mem_no = withdrawal.mem_no
                where date_format(#{search_startDate}, '%Y-%m-%d') <![CDATA[<=]]> date_format(apply.apply_date, '%Y-%m-%d')
                and date_format(apply.apply_date, '%Y-%m-%d') <![CDATA[<=]]> date_format(#{search_endDate}, '%Y-%m-%d')
                and (mem.mem_sex = 'm' or withdrawal.mem_sex = 'm')) sex_man
            , (select count(*)
                from rd_data.tb_event_coupon_member_apply apply
                left join rd_data.tb_member_basic mem on apply.mem_no = mem.mem_no
                left join rd_data.tb_member_withdrawal_bak withdrawal on apply.mem_no = withdrawal.mem_no
                where date_format(#{search_startDate}, '%Y-%m-%d') <![CDATA[<=]]> date_format(apply.apply_date, '%Y-%m-%d')
                and date_format(apply.apply_date, '%Y-%m-%d') <![CDATA[<=]]> date_format(#{search_endDate}, '%Y-%m-%d')
                and (mem.mem_sex = 'f' or withdrawal.mem_sex = 'f')) sex_female
            , (select count(*)
                from rd_data.tb_event_coupon_member_apply apply
                left join rd_data.tb_member_basic mem on apply.mem_no = mem.mem_no
                left join rd_data.tb_member_withdrawal_bak withdrawal on apply.mem_no = withdrawal.mem_no
                where date_format(#{search_startDate}, '%Y-%m-%d') <![CDATA[<=]]> date_format(apply.apply_date, '%Y-%m-%d')
                and date_format(apply.apply_date, '%Y-%m-%d') <![CDATA[<=]]> date_format(#{search_endDate}, '%Y-%m-%d')
                and (mem.mem_sex = 'n' or withdrawal.mem_sex = 'n')) sex_unknown
        from (
            select
                apply_date
                , sum(item_cnt)  itemCnt
                , sum(item_no_1) itemNo1
                , sum(item_no_2) itemNo2
                , sum(item_no_3) itemNo3
                , sum(item_no_4) itemNo4
                , sum(item_no_5) itemNo5
                , sum(item_no_6) itemNo6
                , sum(item_no_7) itemNo7
                , sum(item_no_8) itemNo8
            from (
                select apply.apply_date
                    , item_no
                    , count(item_no) item_cnt
                    , CASE WHEN apply.item_no = 1 THEN count(apply.item_no) ELSE 0 END item_no_1
                    , CASE WHEN apply.item_no = 2 THEN count(apply.item_no) ELSE 0 END item_no_2
                    , CASE WHEN apply.item_no = 3 THEN count(apply.item_no) ELSE 0 END item_no_3
                    , CASE WHEN apply.item_no = 4 THEN count(apply.item_no) ELSE 0 END item_no_4
                    , CASE WHEN apply.item_no = 5 THEN count(apply.item_no) ELSE 0 END item_no_5
                    , CASE WHEN apply.item_no = 6 THEN count(apply.item_no) ELSE 0 END item_no_6
                    , CASE WHEN apply.item_no = 7 THEN count(apply.item_no) ELSE 0 END item_no_7
                    , CASE WHEN apply.item_no = 8 THEN count(apply.item_no) ELSE 0 END item_no_8
                from (
                    select date_format(apply.apply_date, '%Y-%m-%d') apply_date
                        , apply.item_no
                    from rd_data.tb_event_coupon_member_apply apply
                    where date_format(#{search_startDate}, '%Y-%m-%d') <![CDATA[<=]]> date_format(apply.apply_date, '%Y-%m-%d')
                        and date_format(apply.apply_date, '%Y-%m-%d') <![CDATA[<=]]> date_format(#{search_endDate}, '%Y-%m-%d')
                ) apply
                group by apply.apply_date, item_no
            ) dateSum
        ) a
    </select>

    <select id="selectRouletteCalendarList" parameterType="com.dalbit.content.vo.RouletteCalendarVo" resultType="com.dalbit.content.vo.RouletteCalendarVo">
        /* Con_Event.xml - selectRouletteCalendarList */
        select date_format(apply.apply_date, '%Y-%m-%d') the_date
            , (select count(*) from rd_data.stat_member_login_day where the_date = date_format(apply.apply_date, '%Y%m%d')) loginCnt
            , count(apply.apply_date)  itemCnt
            , sum(sex_man)  sex_man
            , sum(sex_female) sex_female
            , sum(sex_unknown) sex_unknown
            , sum(item_no_1) itemNo1
            , sum(item_no_2) itemNo2
            , sum(item_no_3) itemNo3
            , sum(item_no_4) itemNo4
            , sum(item_no_5) itemNo5
            , sum(item_no_6) itemNo6
            , sum(item_no_7) itemNo7
            , sum(item_no_8) itemNo8
        from (
            select
                apply.apply_date
                , if(basic.mem_sex = 'm', 1, 0)    sex_man
                , if(basic.mem_sex = 'f', 1, 0)    sex_female
                , if(basic.mem_sex = 'n', 1, 0)    sex_unknown
                , if(apply.item_no = 1, 1, 0) item_no_1
                , if(apply.item_no = 2, 1, 0) item_no_2
                , if(apply.item_no = 3, 1, 0) item_no_3
                , if(apply.item_no = 4, 1, 0) item_no_4
                , if(apply.item_no = 5, 1, 0) item_no_5
                , if(apply.item_no = 6, 1, 0) item_no_6
                , if(apply.item_no = 7, 1, 0) item_no_7
                , if(apply.item_no = 8, 1, 0) item_no_8
            from rd_data.tb_event_coupon_member_apply apply
            left join rd_data.tb_member_basic basic on apply.mem_no = basic.mem_no
            where date_format(#{search_startDate}, '%Y-%m-%d') <![CDATA[<=]]> date_format(apply.apply_date, '%Y-%m-%d')
                and date_format(apply.apply_date, '%Y-%m-%d') <![CDATA[<=]]> date_format(#{search_endDate}, '%Y-%m-%d')
        ) apply
        group by date_format(apply.apply_date, '%Y-%m-%d')
    </select>
</mapper>