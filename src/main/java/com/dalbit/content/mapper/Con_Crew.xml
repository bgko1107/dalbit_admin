<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.content.dao.Con_CrewDao" >

    <insert id="insertCrewName" parameterType="com.dalbit.content.vo.CrewInsertVo">
    /* Con_Crew.xml - insertCrewName */
        insert into rd_admin.tb_crew_basic
          (crew_name, op_name, reg_date)
        values
          (#{crewName}, #{opName}, now())
    </insert>

    <select id="selectCrewInfo" parameterType="com.dalbit.content.vo.CrewListVo" resultType="com.dalbit.content.vo.CrewListVo">
    /* Con_Crew.xml - selectCrewInfo */
          select *
              from (
                select a.*
                , @RNUM := @RNUM + 1 as rowNum
                from (
                      select
                            crew.idx as crewIdx
                          , crew.crew_name as crewName
                          , bas.mem_nick as crewLeader
                          , lev.level as `level`
                          , (select count(*) from rd_admin.tb_crew_member where crew_idx = crew.idx) as crewCnt
                        from rd_admin.tb_crew_basic crew
                         inner join rd_admin.tb_crew_member crewm on crew.idx = crewm.crew_idx
                         left join rd_data.tb_member_basic bas on crewm.mem_no = bas.mem_no and crewm.leader_yn = 1
                         left join rd_data.tb_member_level lev on bas.mem_no = lev.mem_no
                        group by crewIdx
                        order by `level` desc
                      ) as a
                  , (select @RNUM := 0) r
              ) as b
            where rowNum between #{searchStartNo, jdbcType=INTEGER} and #{searchEndNo, jdbcType=INTEGER}
    </select>

    <select id="selectCrewInfoCnt" parameterType="com.dalbit.content.vo.CrewListVo" resultType="integer">
    /* Con_Crew.xml - selectCrewInfoCnt */
        select count(*)
          from rd_admin.tb_crew_basic
    </select>

    <insert id="insertCrewMember" parameterType="com.dalbit.content.vo.CrewMemberInsertVo">
    /* Con_Crew.xml - insertCrewMember */
        insert into rd_admin.tb_crew_member
        (crew_idx
        , mem_no
        , op_name
        , reg_date)
        values (
        #{crewIdx}
        , #{memNo}
        , #{opName}
        , now()
        )
    </insert>

    <select id="selectMemberInfo" parameterType="com.dalbit.content.vo.CrewMemberInsertVo" resultType="string">
    /* Con_Crew.xml - selectMemberInfo */
      select mem_no
        from rd_data.tb_member_basic
        <where>
            <if test='memInfo != null and memInfo != ""'>
                <choose>
                  <when test='searchType == 1'>
                      mem_no = #{memInfo}
                  </when>
                  <when test='searchType == 2'>
                      mem_userid = #{memInfo}
                  </when>
                  <when test='searchType == 3'>
                      mem_nick = #{memInfo}
                  </when>
                </choose>
            </if>
        </where>
    </select>

    <select id="selectCrewMemberInfo" parameterType="com.dalbit.content.vo.CrewMemberListVo" resultType="com.dalbit.content.vo.CrewMemberListVo">
    /* Con_Crew.xml - selectCrewMemberInfo */
        select *
        from (
            select
              crew.idx as idx
              , (select crew_name from rd_admin.tb_crew_basic where idx = crew.crew_idx) as crewName
              , crew.mem_no as mem_no
              , crew.leader_yn as leader_yn
              , crew.crew_idx as crewIdx
              , (select mem_userid from rd_data.tb_member_basic where crew.mem_no = mem_no) as userId
              , (select mem_nick from rd_data.tb_member_basic where crew.mem_no = mem_no) as memNick
              , (select mem_sex from rd_data.tb_member_basic where crew.mem_no = mem_no) as memSex
              , (select mem_birth_year from rd_data.tb_member_basic where crew.mem_no = mem_no) as birthYear
              , (select start_date from rd_data.tb_broadcast_room where crew.mem_no = mem_no order by end_date desc limit 1) as broadDate
              , (select count(mem_no) from rd_data.tb_broadcast_room where start_date between date_add(now(), interval-1 week) and now() and mem_no = crew.mem_no) as broadCnt
              , (select sum(airtime) from rd_data.tb_broadcast_room where start_date between date_add(now(), interval-1 week) and now() and mem_no = crew.mem_no) as broadTime
              , (select rank from rd_data.tb_ranking_dj_day where ranking_date between date_add(now(), interval-1 day) and now() and mem_no = crew.mem_no) as ranking
              , (select count(*) from rd_data.tb_payment_succ where pay_yn = 'y' and mem_no = crew.mem_no) as payCnt
              , (select sum(pay_amt) from rd_data.tb_payment_succ where pay_yn = 'y' and mem_no = crew.mem_no) as payAmount
              , (select level from rd_data.tb_member_level where mem_no = crew.mem_no) as level
              , @RNUM := @RNUM + 1 as rowNum
            from rd_admin.tb_crew_member crew
              , (select @RNUM := 0) r
        )as a
        where rowNum between #{searchStartNo, jdbcType=INTEGER} and #{searchEndNo, jdbcType=INTEGER}
    </select>

    <select id="selectCrewMemberInfoCnt" parameterType="com.dalbit.content.vo.CrewMemberListVo" resultType="integer">
    /* Con_Crew.xml - selectCrewMemberInfoCnt */
      select count(*)
        from rd_admin.tb_crew_member
    </select>

    <update id="updateCrewLeader" parameterType="com.dalbit.content.vo.CrewMemberInsertVo">
    /* Con_Crew.xml - updateCrewLeader */
        update rd_admin.tb_crew_member
          set leader_yn = #{leader_yn}
          , last_op_name = #{lastOpName}
          , last_upd_date = now()
          where idx = #{idx}
            and crew_idx = #{crewIdx}
            and mem_no = #{memNo}
    </update>

    <update id="updateResetCrewLeader" parameterType="com.dalbit.content.vo.CrewMemberInsertVo">
    /* Con_Crew.xml - updateResetCrewLeader */
      update rd_admin.tb_crew_member
       set leader_yn = 0
       where idx <![CDATA[<>]]> #{idx}
        and crew_idx = #{crewIdx}
    </update>


</mapper>