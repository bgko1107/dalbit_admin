<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.content.dao.Con_BoardAdmDao" >

    <sql id="fanBoardCondition">
        <where>
          <if test='txt_search != null and txt_search != ""'>
              (select mem_no from rd_data.tb_member_basic where mem_no = fan.mem_no) like concat ('%',#{txt_search},'%')
              or (select mem_userid from rd_data.tb_member_basic where mem_no = fan.mem_no) like concat ('%',#{txt_search},'%')
              or (select mem_nick from rd_data.tb_member_basic where mem_no = fan.mem_no) like concat ('%',#{txt_search},'%')
              or (select mem_no from rd_data.tb_member_basic where mem_no = fan.writer_no) like concat ('%',#{txt_search},'%')
              or (select mem_userid from rd_data.tb_member_basic where mem_no = fan.writer_no) like concat ('%',#{txt_search},'%')
              or (select mem_nick from rd_data.tb_member_basic where mem_no = fan.writer_no) like concat ('%',#{txt_search},'%')
          </if>
          <if test='start_sel != null and start_sel != ""'>
              and last_upd_date <![CDATA[>=]]> DATE_FORMAT(#{start_sel}, '%Y.%m.%d 00:00:00')
          </if>
          <if test='end_sel != null and end_sel != ""'>
              and last_upd_date <![CDATA[<=]]> DATE_FORMAT(#{end_sel}, '%Y.%m.%d 23:59:59')
          </if>
        </where>
    </sql>

    <select id="selectFanBoardList" parameterType="com.dalbit.content.vo.BoardAdmFanBoardVo" resultType="com.dalbit.content.vo.BoardAdmFanBoardVo">
        select *
        from (
            select
              idx
              , board_no
              , (select pro.image_profile from rd_data.tb_member_basic bas inner join rd_data.tb_member_profile pro on bas.mem_no = pro.mem_no where pro.mem_no = fan.mem_no) as star_image_profile
              , (select mem_no from rd_data.tb_member_basic where mem_no = fan.mem_no) as star_mem_no
              , (select mem_userid from rd_data.tb_member_basic where mem_no = fan.mem_no) as star_userid
              , (select mem_nick from rd_data.tb_member_basic where mem_no = fan.mem_no) as star_mem_nick
              , (select mem_state from rd_data.tb_member_basic where mem_no = fan.mem_no) as star_mem_state
              , (select mem_sex from rd_data.tb_member_basic where mem_no = fan.mem_no) as star_mem_sex
              , (select mem_birth_year from rd_data.tb_member_basic where mem_no = fan.mem_no) as star_birth_year
              , (select pro.image_profile from rd_data.tb_member_basic bas inner join rd_data.tb_member_profile pro on bas.mem_no = pro.mem_no where pro.mem_no = fan.writer_no) as fan_image_profile
              , (select mem_no from rd_data.tb_member_basic where mem_no = fan.writer_no) as fan_mem_no
              , (select mem_userid from rd_data.tb_member_basic where mem_no = fan.writer_no) as fan_userid
              , (select mem_nick from rd_data.tb_member_basic where mem_no = fan.writer_no) as fan_mem_nick
              , (select mem_state from rd_data.tb_member_basic where mem_no = fan.writer_no) as fan_mem_state
              , (select mem_sex from rd_data.tb_member_basic where mem_no = fan.writer_no) as fan_mem_sex
              , (select mem_birth_year from rd_data.tb_member_basic where mem_no = fan.writer_no) as fan_birth_year
              , status
              , last_upd_date
              , contents
              , (select count(*) from rd_data.tb_member_fanboard WHERE mem_no =  fan.mem_no and `status` = 1 AND board_no = fan.board_no AND depth = 2 ) as replyCnt
              , @RNUM := @RNUM +1 as rowNum
            from rd_data.tb_member_fanboard fan
                , (select @RNUM := 0) r
                <include refid="fanBoardCondition"/>
            order by idx desc
        ) a
        where rowNum between #{searchStartNo, jdbcType=INTEGER} and #{searchEndNo, jdbcType=INTEGER}
    </select>

    <select id="selectFanBoardListCnt" parameterType="com.dalbit.content.vo.BoardAdmFanBoardVo" resultType="integer">
      select
        count(*)
      from rd_data.tb_member_fanboard fan
        <include refid="fanBoardCondition"/>
    </select>

    <update id="deleteFanBoard">
        update rd_data.tb_member_fanboard
        set `status` = 2
          ,  contents = #{contents}
        where idx = #{idx}
    </update>

    <select id="selectReply" parameterType="com.dalbit.content.vo.BoardAdmFanBoardReplyVo" resultType="com.dalbit.content.vo.BoardAdmFanBoardReplyVo">
        SELECT
            a.idx AS board_idx,
            a.board_no AS board_no,
            a.writer_no AS writer_mem_no,
            b.mem_nick AS nickName,
            b.mem_userid as userId,
            b.mem_sex AS memSex,
            b.mem_birth_year,
            ( SELECT image_profile FROM rd_data.tb_member_profile WHERE mem_no = a.writer_no ) AS profileImage,
            a.contents AS contents,
            a.`status` AS `status`,
            a.last_upd_date AS writeDate,
            depth
         from (select idx, board_no, contents, writer_no, `status`, last_upd_date, depth from rd_data.tb_member_fanboard where mem_no = #{mem_no} and board_no = #{board_no} and `status` = 1) as a
          join rd_data.tb_member_basic as b on a.writer_no = b.mem_no
          order by writeDate desc
    </select>
    <sql id="storyCondition">
        <where>
            <if test='txt_search != null and txt_search != ""'>
                <choose>
                    <when test='searchType == 1'>
                        bas.mem_no like CONCAT('%',#{txt_search},'%')
                    </when>
                    <when test='searchType == 2'>
                        bas.mem_userid like CONCAT('%',#{txt_search},'%')
                    </when>
                    <when test='searchType == 3'>
                        bas.mem_nick like CONCAT('%',#{txt_search},'%')
                    </when>
                    <when test='searchType == 4'>
                        sto.writer_no like CONCAT('%', #{txt_search}, '%')
                    </when>
                    <when test='searchType == 5'>
                        sto.mem_userid like CONCAT('%', #{txt_search}, '%')
                    </when>
                    <when test='searchType == 6'>
                        sto.mem_nick like CONCAT('%', #{txt_search}, '%')
                    </when>
                    <otherwise>
                        (bas.mem_no like CONCAT('%',#{txt_search},'%') or sto.writer_no like CONCAT('%', #{txt_search}, '%')
                        OR bas.mem_userid like CONCAT('%',#{txt_search},'%') or sto.mem_userid like CONCAT('%', #{txt_search}, '%')
                        OR bas.mem_nick like CONCAT('%',#{txt_search},'%') or sto.mem_nick like CONCAT('%', #{txt_search}, '%'))
                    </otherwise>
                </choose>
            </if>
            <if test='start_sel != null and start_sel !=""'>
                 and sto.write_date <![CDATA[>=]]> DATE_FORMAT(#{start_sel}, '%Y.%m.%d 00:00:00')
            </if>
            <if test='end_sel != null and end_sel != ""'>
                 and sto.write_date <![CDATA[<=]]> DATE_FORMAT(#{end_sel}, '%Y.%m.%d 23:59:59')
            </if>
        </where>
    </sql>

    <select id="selectStoryList" parameterType="com.dalbit.content.vo.BoardAdmStoryVo" resultType="com.dalbit.content.vo.BoardAdmStoryVo">
    /* Con_BoardAdm.xml - selectStoryList*/
      select *
        from (
                select
                   sto.idx as storyIdx,
                   sto.room_no as room_no,
                   bas.mem_no     as dj_mem_no,
                   bas.mem_nick   as dj_mem_nick,
                   bas.mem_userid as dj_mem_userid,
                   bas.mem_sex    as dj_mem_sex,
                   bas.mem_birth_year as dj_birth_year,
                   bro.title      as title,
                   sto.mem_nick   as send_mem_nick,
                   sto.mem_userid as send_mem_userid,
                   sto.mem_sex    as send_mem_sex,
                   sto.writer_no as send_mem_no,
                   (select bas.mem_birth_year
                      from rd_data.tb_broadcast_room_story sto inner join rd_data.tb_member_basic bas on sto.writer_no = bas.mem_no
                      where bas.mem_no = send_mem_no group by bas.mem_no) as send_birth_year,
                   sto.write_date as send_date,
                   sto.contents   as story_content,
                   @RNUM := @RNUM + 1 as rowNum
                 from rd_data.tb_broadcast_room bro
                   inner join rd_data.tb_broadcast_room_story sto on sto.room_no = bro.room_no
                   inner join rd_data.tb_member_basic bas on bro.mem_no = bas.mem_no
                  , (select @RNUM := 0) r
                  <include refid="storyCondition"/>
                  order by sto.idx desc
        ) a
        where rowNum between #{searchStartNo, jdbcType=INTEGER} and #{searchEndNo, jdbcType=INTEGER}
    </select>

    <select id="selectStoryListCnt" parameterType="com.dalbit.content.vo.BoardAdmStoryVo" resultType="integer">
      /* Con_BoardAdm.xml - selectStoryListCnt*/
      select
        count(*)
      from rd_data.tb_broadcast_room bro
              inner join rd_data.tb_broadcast_room_story sto on sto.room_no = bro.room_no
              inner join rd_data.tb_member_basic bas on bro.mem_no = bas.mem_no
        <include refid="storyCondition"/>
    </select>

    <select id="callStoryDelete" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.common.vo.ProcedureVo">
        /* Con_BoardAdm.xml - callStoryDelete */
        call rd_admin.sp_admin_broadcast_room_story_delete(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

</mapper>