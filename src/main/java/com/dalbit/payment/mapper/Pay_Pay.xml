<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.payment.dao.Pay_PayDao" >

    <sql id="payCondition">
        select
            pay.order_id
            , pay.mem_no
            , pay.pay_way
            , pay.pay_dt_comein
            , pay.pay_yn
            , pay.pay_ok_date
            , pay.pay_ok_time
            , pay.pay_slct
            , pay.pay_amt
            , pay.pay_code
            , pay.chrgr_yn
            , pay.app_ver
            , pay.first_pay_yn
            , pay.card_no
            , pay.card_nm
            , pay.phone_no
            , pay.bank_code
            , pay.account_no
            , pay.rcpt_dt
            , pay.rcpt_nm
            , pay.store_id
            , pay.cancel_dt
            , pay.cancel_state
            , pay.fail_msg
            , pay.op_name
            , pay.bill_id
            , pay.os
            , pay.dal_cnt
            ,CASE
                WHEN pay.pay_way = 'CN'
                THEN pay.card_no
                WHEN pay.pay_way = 'MC'
                THEN pay.phone_no
                WHEN pay.pay_way = 'VA'
                THEN pay.account_no
                WHEN pay.pay_way = 'InApp'
                THEN pay.bill_id
            END AS pay_info_no
            ,CASE
                WHEN pay.pay_way = 'CN'
                THEN pay.card_nm
                WHEN pay.pay_way = 'VA'
                THEN pay.bank_code
            END AS pay_info_nm
            , summary.memCnt as count
            , summary.paySum as amount
            , @RNUM := @RNUM + 1 as rowNum
            , mem_nick
            , ruby as tot_dal_cnt
        from rd_data.tb_payment_succ pay
            left join (select mem_no, count(mem_no) memCnt, sum(pay_amt) paySum from rd_data.tb_payment_succ group by mem_no) summary on pay.mem_no = summary.mem_no
            left join (select mem_no, mem_nick from rd_data.tb_member_basic) member on pay.mem_no = member.mem_no
            left join (select mem_no, ruby from rd_data.tb_member_wallet) wallet on pay.mem_no = wallet.mem_no
            , (select @RNUM := 0) r
        order by pay_dt_comein desc
    </sql>
    <select id="getPayList" parameterType="com.dalbit.payment.vo.Pay_PayVo" resultType="com.dalbit.payment.vo.Pay_PayVo">
        /* Pay_Pay.xml - getPayList */
        select *
        from (
        <include refid="payCondition"/>
        ) a
        limit #{pageStart}, #{pageCnt}
    </select>

    <select id="getPayListCnt" parameterType="com.dalbit.payment.vo.Pay_PayVo" resultType="integer">
        /* Pay_Pay.xml - getPayListCnt */
        select
          count(*)
        from (
        <include refid="payCondition"/>
        ) a
    </select>

</mapper>