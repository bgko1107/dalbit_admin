<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.member.dao.M_MemberDao" >

    <select id="callMemberLogin" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.common.vo.ProcedureVo">
        call sp_member_login(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callMemberList_cnt" parameterType="com.dalbit.member.vo.MemberListVo" resultType="integer">
        /* M_Member.xml - callMemberList_cnt */
        select count(*) as totalCnt
        from tb_member_basic b
        , tb_member_profile p
        where b.mem_no = p.mem_no
        <!--<if test='checkDate == "true"'>-->
            <!--and DATE_FORMAT(mem_join_date, '%Y%m%d') <![CDATA[ >= ]]> #{stDate} and DATE_FORMAT(mem_join_date, '%Y%m%d') <![CDATA[ <= ]]> #{edDate}-->
        <!--</if>-->
        <if test='search != null'>
            <choose>
                <when test='gubun == "9999"'>      <!-- 전체 -->
                    AND (b.mem_no LIKE CONCAT('%',#{search},'%')
                    OR b.mem_nick LIKE CONCAT('%',#{search},'%')
                    OR b.mem_phone LIKE CONCAT('%',#{search},'%')
                    OR p.mem_name LIKE CONCAT('%',#{search},'%'))
                </when>
                <when test='gubun == "1"'>      <!-- userid -->
                    AND p.mem_no LIKE CONCAT('%',#{search},'%')
                </when>
                <when test='gubun == "2"'>      <!-- 닉네임 -->
                    AND b.mem_nick LIKE CONCAT('%',#{search},'%')
                </when>
                <when test='gubun == "3"'>      <!-- 폰번호 -->
                    AND p.mem_phone LIKE CONCAT('%',#{search},'%')
                </when>
                <otherwise>                      <!-- 이름 -->
                    AND p.mem_name LIKE CONCAT('%',#{search},'%')
                </otherwise>
            </choose>
        </if>
    </select>
    <select id="callMemberList" parameterType="com.dalbit.member.vo.MemberListVo" resultType="com.dalbit.member.vo.MemberListVo">
        /* M_Member.xml - callMemberList */
        select b.mem_id     as memId
            , b.mem_no       as memNo
            , b.mem_nick     as memNick
            , p.mem_name     as memName
            , b.mem_phone    as memPhone
            , b.mem_slct     as memSlct
            , @RNUM := @RNUM + 1 as rowNum
        from tb_member_basic b
            , tb_member_profile p
            , (SELECT @RNUM := #{pageStart}) r
        where b.mem_no = p.mem_no
        <!--<if test='checkDate == "true"'>-->
           <!--and DATE_FORMAT(mem_join_date, '%Y%m%d') <![CDATA[ >= ]]> #{stDate} and DATE_FORMAT(mem_join_date, '%Y%m%d') <![CDATA[ <= ]]> #{edDate}-->
        <!--</if>-->
        <if test='search != null'>
            <choose>
                <when test='gubun == "9999"'>      <!-- 전체 -->
                    AND (b.mem_no LIKE CONCAT('%',#{search},'%')
                    OR b.mem_nick LIKE CONCAT('%',#{search},'%')
                    OR b.mem_phone LIKE CONCAT('%',#{search},'%')
                    OR p.mem_name LIKE CONCAT('%',#{search},'%'))
                </when>
                <when test='gubun == "1"'>      <!-- userid -->
                    AND p.mem_no LIKE CONCAT('%',#{search},'%')
                </when>
                <when test='gubun == "2"'>      <!-- 닉네임 -->
                    AND b.mem_nick LIKE CONCAT('%',#{search},'%')
                </when>
                <when test='gubun == "3"'>      <!-- 폰번호 -->
                    AND b.mem_phone LIKE CONCAT('%',#{search},'%')
                </when>
                <otherwise>                      <!-- 이름 -->
                    AND p.mem_name LIKE CONCAT('%',#{search},'%')
                </otherwise>
            </choose>
        </if>
        ORDER BY ${orderColumnName} ${orderDir}
        limit #{pageStart}, #{pageCnt}
    </select>

    <select id="callMemberInfo" parameterType="com.dalbit.member.vo.MemberInfoVo" resultType="com.dalbit.member.vo.MemberInfoVo">
      /* M_Member.xml - callMemberInfo */
       SELECT
          a.mem_no						as memNo
          ,a.mem_id                     as memId
          ,b.mem_name                   as memName
          ,a.mem_nick 				    as memNick
          ,a.mem_phone                  as memPhone
          ,a.mem_passwd                 as memPasswd
          ,a.mem_sex 					as memSex
          ,lpad(a.mem_birth_year,4,'0')   as birthYear
          ,lpad(a.mem_birth_month,2,'0')  as birthMonth
          ,lpad(a.mem_birth_day,2,'0')    as birthDay
          ,a.mem_slct                   as memSlct
          ,a.mem_adid                   as memAdid
          ,a.mem_state                  as state
          ,DATE_FORMAT(a.mem_join_date,'%Y-%m-%d %H:%i:%s')    as memJoinDate
          ,DATE_FORMAT(a.last_upd_date,'%Y-%m-%d %H:%i:%s')    as lastUpdDate
          ,b.mem_email                  as memEmail
          ,b.image_profile 		        as profileImage
          ,c.level 						as level
          ,c.grade 						as grade
          ,c.exp 						as exp

          ,(select count(*) as cnt FROM tb_broadcast_room b, tb_member_broadcast_broadcasting m WHERE b.room_no = m.room_no AND b.mem_no = a.mem_no) as broadcastingCnt
          ,(select count(*) as cnt from tb_member_broadcast_listening where mem_no = a.mem_no) as listeningCnt
          ,(select count(*) as cnt from tb_member_fanstar where mem_no_fan = a.mem_no) as starCnt   /*내가 등록한 start*/
          ,(select count(*) as cnt from tb_member_fanstar where mem_no_star = a.mem_no) as fanCnt   /*나를 등록한 fan*/
          ,(select count(*) as cnt from tb_broadcast_room where CHAR_LENGTH(notice) > 1 and mem_no = a.mem_no) noticeCnt /*방송중 공지사항*/
          ,(select count(*) as cnt From tb_member_report where mem_no = a.mem_no) reportCnt /*내가 신고한사람*/
          ,(select count(*) as cnt From tb_member_report where reported_mem_no = a.mem_no) reportMemCnt /*나를 신고한사람*/
        FROM tb_member_basic a, tb_member_profile b, tb_member_level c
       WHERE a.mem_no = b.mem_no AND a.mem_no = c.mem_no
         AND a.mem_no = #{memNo}
    </select>

    <select id="callMemberLevelList" parameterType="com.dalbit.member.vo.MemberInfoLevelListVo" resultType="com.dalbit.member.vo.MemberInfoLevelListVo">
      /* M_Member.xml - callMemberLevelList */
       SELECT 'level' as gubun
               ,level
               ,grade
               ,exp
         FROM tbl_level_exp
        ORDER BY LEVEL DESC
    </select>

    <select id="callMemberGradeList" parameterType="com.dalbit.member.vo.MemberInfoLevelListVo" resultType="com.dalbit.member.vo.MemberInfoLevelListVo">
      /* M_Member.xml - callMemberGradeList */
       SELECT DISTINCT
               'grade'  as gubun
               ,grade
         FROM tbl_level_exp
        ORDER BY LEVEL DESC

    </select>

    <select id="callMemberEdit" parameterType="com.dalbit.member.vo.MemberListVo">
      /* M_Member.xml - callMemberGradeList */
       UPDATE tb_member_profile
          SET image_profile = #{profileImage}
              ,grade_profile = #{profileImageGrade}
              ,last_upd_date = now()
        WHERE mem_no = #{memNo}

    </select>
</mapper>