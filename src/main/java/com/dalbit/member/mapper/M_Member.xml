<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.member.dao.M_MemberDao" >

    <resultMap id="result" type="com.dalbit.member.vo.P_MemberInfoVo">
        <result property="mem_no" column="mem_no"/>
        <result property="mem_join_date" column="join_date"/>
        <result property="last_upd_date"  column="upd_date"/>
    </resultMap>

    <select id="callMemberLogin" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.common.vo.ProcedureVo">
        call sp_member_login(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="getMemberList" parameterType="com.dalbit.member.vo.MemberListVo" resultType="com.dalbit.member.vo.MemberListVo">
        select b.mem_id
            , b.mem_no
            , b.mem_nick
            , p.mem_name
            , b.mem_phone
            , b.mem_slct
        from tb_member_basic b
            , tb_member_profile p
        where b.mem_no = p.mem_no
        <if test='search != null'>
            <choose>
                <when test='gubun == "0"'>      <!-- 전체 -->
                    and (b.mem_no like CONCAT('%',#{search},'%')
                    or b.mem_nick like CONCAT('%',#{search},'%')
                    or b.mem_phone like CONCAT('%',#{search},'%')
                    or p.mem_name like CONCAT('%',#{search},'%'))
                </when>
                <when test='gubun == "1"'>      <!-- userid -->
                    and p.mem_no like CONCAT('%',#{search},'%')
                </when>
                <when test='gubun == "2"'>      <!-- 닉네임 -->
                    and p.mem_nick like CONCAT('%',#{search},'%')
                </when>
                <when test='gubun == "3"'>      <!-- 폰번호 -->
                    and p.mem_phone like CONCAT('%',#{search},'%')
                </when>
                <otherwise>                      <!-- 이름 -->
                    and p.mem_name like CONCAT('%',#{search},'%')
                </otherwise>
            </choose>
        </if>
    </select>

    <select id="callMemberInfo" parameterType="com.dalbit.member.vo.P_MemberInfoVo" resultMap="result" resultType="com.dalbit.member.vo.P_MemberInfoVo">
       SELECT
          a.mem_no						as mem_no
          ,a.mem_id                     as memId
          ,a.mem_phone                  as phone
          ,a.mem_passwd                 as passwd
          ,a.mem_nick 				    as nickName
          ,a.mem_sex 					as memSex
          ,lpad(a.mem_birth_year,4,'0')   as birthYear
          ,lpad(a.mem_birth_month,2,'0')  as birthMonth
          ,lpad(a.mem_birth_day,2,'0')    as birthDay
          ,a.mem_slct                   as slct
          ,a.mem_adid                   as adid
          ,a.mem_state                  as state
          ,DATE_FORMAT(a.mem_join_date,'%Y-%m-%d %H:%i:%s')    as join_date
          ,DATE_FORMAT(a.last_upd_date,'%Y-%m-%d %H:%i:%s')    as upd_date
          ,b.mem_name                   as name
          ,b.mem_email                  as email
          ,b.image_profile 		        as profileImage
          ,c.level 						as level
          ,c.grade 						as grade
          ,c.exp 						as exp
          ,(select count(*) as cnt from tb_member_broadcast_broadcasting where mem_no = a.mem_no) as broadcastingCnt
          ,(select count(*) as cnt from tb_member_broadcast_listening where mem_no = a.mem_no) as listeningCnt
          ,(select count(*) as cnt from tb_member_fanstar where mem_no_fan = a.mem_no) as starCnt   /*내가 등록한 start*/
          ,(select count(*) as cnt from tb_member_fanstar where mem_no_star = a.mem_no) as fanCnt   /*내가 등록한 fan*/
          /*나를 star 등록*/
          /*나를 fan 등록*/
        FROM tb_member_basic a, tb_member_profile b, tb_member_level c
       WHERE a.mem_no = b.mem_no AND a.mem_no = c.mem_no
         AND a.mem_no = #{mem_no}
    </select>

    <select id="callMemberLevelList" parameterType="com.dalbit.member.vo.MemberInfoLevelListVo" resultType="com.dalbit.member.vo.MemberInfoLevelListVo">
       SELECT 'level' as gubun
               ,level
               ,grade
               ,exp
         FROM tbl_level_exp
        ORDER BY LEVEL DESC
    </select>

    <select id="callMemberGradeList" parameterType="com.dalbit.member.vo.MemberInfoLevelListVo" resultType="com.dalbit.member.vo.MemberInfoLevelListVo">
       SELECT DISTINCT
               'grade'  as gubun
               ,grade
         FROM tbl_level_exp
        ORDER BY LEVEL DESC

    </select>


</mapper>