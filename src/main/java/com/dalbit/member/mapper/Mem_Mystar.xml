<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.member.dao.Mem_MystarDao" >

    <!--<select id="callMystarHistory" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.member.vo.procedure.P_MemberMystarOutputVo">-->
        <!--/* Mem_Mystar.xml - callMystarHistory */-->
        <!--call rd_admin.sp_admin_member_Mystar_history(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})-->
    <!--</select>-->

    <select id="callMystarHistory" parameterType="com.dalbit.member.vo.procedure.P_MemberMystarInputVo" resultType="com.dalbit.member.vo.procedure.P_MemberMystarOutputVo">
      select @rownum := @rownum + 1 as rowNum,
              a.*
         from ( select a.mem_no_star
                        ,ifnull(mem_userid ,(select mem_userid From rd_data.tb_member_withdrawal_bak where mem_no = a.mem_no_star )) as mem_no_start_id
                        ,ifnull(mem_nick, (select mem_nick From rd_data.tb_member_withdrawal_bak where mem_no = a.mem_no_star )) as mem_no_start_nick
                        ,(select count(*) AS accumCnt from rd_data.tb_member_broadcast_item where mem_no = mem_no_fan and gifted_mem_no = a.mem_no_star) as accumCnt
                        ,(select tot_rcv_ruby_cnt from rd_data.tb_member_gift_mem where gifted_mem_no = mem_no_star and mem_no = #{mem_no}) as totalItemCnt
                        , b.inner
                        , a.state
                        , (select ifnull(mem_no,a.delete_op) from rd_data.tb_member_basic where mem_no = a.delete_op) as delMemNo
                        , (select ifnull(mem_nick,'') from rd_data.tb_member_basic where mem_no = a.delete_op) as delMemNick
                        , a.last_upd_date
                        , if(a.state = '1',a.last_upd_date,'') as regDateFormat
                        , if(a.state = '0',a.last_upd_date,'') as delDateFormat
                   From rd_data.tb_member_fanstar_history a join rd_data.tb_member_basic b on a.mem_no_star = b.mem_no
                  where mem_no_fan = #{mem_no} and b.mem_state != 5
                  order by totalItemCnt desc, last_upd_date desc ) as a, (select @rownum := #{pageNo} ) AS d

          limit #{pageNo}, #{pageCnt}
    </select>

    <select id="callMystarHistory_totalCnt" parameterType="com.dalbit.member.vo.procedure.P_MemberMystarInputVo" resultType="integer">
        select count(*) as totalCnt From rd_data.tb_member_fanstar_history a join rd_data.tb_member_basic b on a.mem_no_star = b.mem_no where a.mem_no_fan = #{mem_no} and b.mem_state != 5
    </select>

    <!--<select id="callMyfanHistory" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.member.vo.procedure.P_MemberMystarOutputVo">-->
    <!--/* Mem_Mystar.xml - callMyfanHistory */-->
    <!--call rd_admin.sp_admin_member_Myfan_history(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})-->
    <!--</select>-->

    <select id="callMyfanHistory" parameterType="com.dalbit.member.vo.procedure.P_MemberMystarInputVo" resultType="com.dalbit.member.vo.procedure.P_MemberMystarOutputVo">
      select @rownum := @rownum + 1 as rowNum,
              a.*
         from ( select a.mem_no_fan
                        ,ifnull(mem_userid ,(select mem_userid From rd_data.tb_member_withdrawal_bak where mem_no = a.mem_no_fan )) as mem_no_fan_id
                        ,ifnull(mem_nick, (select mem_nick From rd_data.tb_member_withdrawal_bak where mem_no = a.mem_no_fan )) as mem_no_fan_nick
                        ,(select count(*) AS accumCnt from rd_data.tb_member_broadcast_item where mem_no = mem_no_fan and gifted_mem_no = #{mem_no}) as accumCnt
                        ,(select tot_rcv_ruby_cnt from rd_data.tb_member_gift_mem where gifted_mem_no = #{mem_no} and mem_no = mem_no_fan) as totalItemCnt
                        , b.inner
                        , a.state
                        , (select ifnull(mem_no,a.delete_op) from rd_data.tb_member_basic where mem_no = a.delete_op) as delMemNo
                        , (select ifnull(mem_nick,'') from rd_data.tb_member_basic where mem_no = a.delete_op) as delMemNick
                        , a.last_upd_date
                        , if(a.state = '1',a.last_upd_date,'') as regDateFormat
                        , if(a.state = '0',a.last_upd_date,'') as delDateFormat
                   From rd_data.tb_member_fanstar_history a join rd_data.tb_member_basic b on a.mem_no_fan = b.mem_no
                  where mem_no_star = #{mem_no} and b.mem_state != 5
                  order by totalItemCnt desc, last_upd_date desc ) as a, (select @rownum := #{pageNo} ) AS d
          limit #{pageNo}, #{pageCnt}
    </select>

    <select id="callMyfanHistory_totalCnt" parameterType="com.dalbit.member.vo.procedure.P_MemberMystarInputVo" resultType="integer">
        select count(*) as totalCnt From rd_data.tb_member_fanstar a join rd_data.tb_member_basic b on a.mem_no_fan = b.mem_no where a.mem_no_star = #{mem_no} and b.mem_state != 5
    </select>

</mapper>