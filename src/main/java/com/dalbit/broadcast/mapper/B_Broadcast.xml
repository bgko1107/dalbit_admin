<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.broadcast.dao.B_BroadcastDao" >
    <select id="callBroadcastTypeList" parameterType="com.dalbit.broadcast.vo.BroadcastTypeListVo" resultType="com.dalbit.broadcast.vo.BroadcastTypeListVo">
        /* B_Broadcast.xml - callBroadcastTypeList */
        SELECT *
          FROM tbl_code_define
         WHERE type=#{type}
         ORDER BY VALUE
    </select>

    <select id="callBroadcastList" parameterType="com.dalbit.broadcast.vo.BroadcastListVo" resultType="com.dalbit.broadcast.vo.BroadcastListVo">
        /* B_Broadcast.xml - callBroadcastList */
        SELECT a.room_no       AS roomNo
                ,a.title        AS title
                ,a.msg_welcom   AS msgWelcom
                ,a.subject_type,(select code from tbl_code_define aa where aa.value = a.subject_type and aa.type ='subject_type') type
                ,(CASE  a.type_entry WHEN 0 THEN '제한없음' WHEN 1 THEN '펜만' WHEN 2 THEN '20세이상' end) AS typeEntry
                ,a.notice       AS notice
                ,(SELECT code FROM tbl_code_define aa WHERE aa.value = a.state and aa.type = 'broadcast_state') state
                ,a.count_entry  AS count_entry
                ,a.count_good   AS count_good
                ,DATE_FORMAT(a.start_date,'%Y-%m-%d %H:%i:%s')   AS start_date
                ,a.mem_no       AS memNo
                ,b.mem_nick     AS memNick
                ,b.mem_sex      AS memSex
                ,b.mem_id       AS memId
          FROM tb_broadcast_room a, tb_member_basic b
         WHERE state != 4
           AND a.mem_no = b.mem_no
          <if test='value != "9999"'>
            AND a.subject_type = #{value}
          </if>
          <if test='search != null and search != ""'>
            <choose>
                <when test="gubun == 9999">      <!-- 전체 -->
                    AND (b.mem_id LIKE CONCAT('%',#{search},'%')
                    OR b.mem_nick LIKE CONCAT('%',#{search},'%')
                    OR a.title LIKE CONCAT('%',#{search},'%'))
                </when>
                <when test="gubun == 1">      <!-- DJ 닉네임 -->
                    AND b.mem_nick LIKE CONCAT('%',#{search},'%')
                </when>
                <when test="gubun == 2">      <!-- DJ ID -->
                    AND b.mem_id LIKE CONCAT('%',#{search},'%')
                </when>
                <otherwise>                   <!-- 방송제목 -->
                    AND a.title LIKE CONCAT('%',#{search},'%')
                </otherwise>
            </choose>
        </if>
         ORDER BY count_entry, count_good, start_date DESC
    </select>

    <select id="callBroadcastInfo" parameterType="com.dalbit.broadcast.vo.BroadcastInfoVo" resultType="com.dalbit.broadcast.vo.BroadcastInfoVo">
      /* B_Broadcast.xml - callBroadcastInfo */
        SELECT  a.room_no          as roomNo
                ,a.subject_type     as type
                ,a.title            as title
                ,a.image_background as backgroundImage
                ,a.msg_welcom       as msgWelcom
                ,a.type_entry       as typeEntry
                ,(select code FROM tbl_code_define aa WHERE value = a.state and type = 'broadcast_state') as state
                ,DATE_FORMAT(a.start_date,'%Y-%m-%d %H:%i:%s')     as liveSt
                ,DATE_FORMAT(a.end_date,'%Y-%m-%d %H:%i:%s')       as liveEd
                ,DATE_FORMAT(a.last_upd_date,'%Y-%m-%d %H:%i:%s')  as infoEditDate
                ,b.mem_no           as memNo
                ,b.mem_id           as memId
                ,b.mem_nick         as memNick
                ,b.mem_sex          as memSex
                ,a.count_good       as goodCnt
                ,d.gift_cnt         as giftCnt
                ,(SELECT count(*) cnt from tb_broadcast_room_story where room_no = a.room_no) as contentsCnt
                ,(select count(*) cnt from tb_broadcast_room_member aa, tb_member_basic bb where aa.mem_no = bb.mem_no and aa.room_no=a.room_no) as listenCnt
                ,(select count(*) cnt from tb_broadcast_room_block where mem_no = a.mem_no) as forceKickCnt
          from tb_broadcast_room a, tb_member_basic b,
                tb_member_basic c, tb_broadcast_room_member d
         where a.mem_no = b.mem_no
           and a.mem_no = c.mem_no
           and a.room_no = d.room_no
           and a.mem_no = d.mem_no
           and a.room_no =#{roomNo}
    </select>

</mapper>