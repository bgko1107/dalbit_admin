<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.broadcast.dao.B_LiveDao" >

    <select id="callLiveList" parameterType="com.dalbit.broadcast.vo.LiveListVo" resultType="com.dalbit.broadcast.vo.LiveListVo">
        /* B_Live.xml - callLiveList */
        select a.*, @RNUM := @RNUM + 1 as rowNum from (
        SELECT a.room_no       AS roomNo
                ,a.title        AS title
                ,a.msg_welcom   AS msgWelcom
                ,a.subject_type,(select code from rd_data.tbl_code_define aa where aa.value = a.subject_type and aa.type ='subject_type') type
                ,(CASE  a.type_entry WHEN 0 THEN '제한없음' WHEN 1 THEN '펜만' WHEN 2 THEN '20세이상' end) AS typeEntry
                ,a.notice       AS notice
                ,(SELECT code FROM rd_data.tbl_code_define aa WHERE aa.value = a.state and aa.type = 'broadcast_state') state
                ,a.count_entry  AS count_entry
                ,a.count_good   AS count_good
                ,DATE_FORMAT(a.start_date,'%Y-%m-%d %H:%i:%s')   AS startDate
                ,a.mem_no       AS memNo
                ,b.mem_nick     AS memNick
                ,b.mem_sex      AS memSex
                ,b.mem_id       AS memId
                ,a.badge_recomm as badgeRecomm
                ,a.badge_popular as badgePopular
                ,a.badge_newdj   as badgeNewdj
                ,a.expected_end_date  as expectedEndDate
                ,a.last_upd_date  as lastUpdDate
                ,c.image_profile as imageProfile
                ,(CASE WHEN a.badge_recomm = 1  and a.badge_popular = 1  and a.badge_newdj = 1 THEN 'ALL'
                        WHEN a.badge_recomm = 1  and a.badge_popular = 1 THEN 'repo'
                        WHEN a.badge_recomm = 1  and a.badge_newdj = 1 THEN 'rene'
                        WHEN a.badge_popular = 1  and a.badge_newdj = 1 THEN 'pone'
                        WHEN a.badge_recomm = 1 THEN 're'
                        WHEN a.badge_popular = 1 THEN 'po'
                        WHEN a.badge_newdj = 1 THEN 'ne'
                        end) AS tag
          FROM rd_data.tb_broadcast_room a, rd_data.tb_member_basic b, rd_data.tb_member_profile c
         WHERE a.mem_no = b.mem_no
           and a.mem_no = c.mem_no
--            AND state != 4
        <if test='search != null and search != ""'>
          <choose>
              <when test='gubun == "9999"'>      <!-- 전체 -->
                  AND (b.mem_no LIKE CONCAT('%',#{search},'%')
                  OR b.mem_nick LIKE CONCAT('%',#{search},'%')
                  OR b.mem_phone LIKE CONCAT('%',#{search},'%')
                  OR c.mem_name LIKE CONCAT('%',#{search},'%'))
              </when>
              <when test='gubun == "1"'>      <!-- userid -->
                  AND b.mem_no LIKE CONCAT('%',#{search},'%')
              </when>
              <when test='gubun == "2"'>      <!-- 닉네임 -->
                  AND b.mem_nick LIKE CONCAT('%',#{search},'%')
              </when>
              <when test='gubun == "3"'>      <!-- 폰번호 -->
                  AND b.mem_phone LIKE CONCAT('%',#{search},'%')
              </when>
              <otherwise>                      <!-- 이름 -->
                  AND c.mem_name LIKE CONCAT('%',#{search},'%')
              </otherwise>
          </choose>
        </if>
        <if test='searchBroad != null and searchBroad != ""'>
            <choose>
            <when test="gubunBroad == 9999">      <!-- 전체 -->
                AND (a.title LIKE CONCAT('%',#{searchBroad},'%')
                OR a.msg_welcom LIKE CONCAT('%',#{searchBroad},'%')
                OR a.notice LIKE CONCAT('%',#{searchBroad},'%'))
            </when>
            <when test="gubunBroad == 1">      <!-- 방송제목 -->
                AND a.title LIKE CONCAT('%',#{searchBroad},'%')
            </when>
            <when test="gubunBroad == 2">      <!-- 인사말 -->
                AND a.msg_welcom LIKE CONCAT('%',#{searchBroad},'%')
            </when>
                <otherwise>               <!-- 방송공지 -->
                    AND a.notice LIKE CONCAT('%',#{searchBroad},'%')
                </otherwise>
            </choose>
        </if>
        ORDER BY ${orderColumnName} ${orderDir}
        limit #{pageStart}, #{pageCnt}
        ) a, (SELECT @RNUM := #{pageStart}) r
    </select>

    <select id="callLiveList_cnt" parameterType="com.dalbit.broadcast.vo.LiveListVo" resultType="integer">
        /* B_Live.xml - callLiveList */
        SELECT count(*) totalCnt
        FROM rd_data.tb_broadcast_room a, rd_data.tb_member_basic b, rd_data.tb_member_profile c
        WHERE a.mem_no = b.mem_no
        and a.mem_no = c.mem_no
        --            AND state != 4
        <if test='search != null and search != ""'>
            <choose>
                <when test="gubun == 9999">      <!-- 전체 -->
                    AND (b.mem_id LIKE CONCAT('%',#{search},'%')
                    OR b.mem_nick LIKE CONCAT('%',#{search},'%')
                    OR a.title LIKE CONCAT('%',#{search},'%'))
                </when>
                <when test="gubun == 1">      <!-- DJ 닉네임 -->
                    AND b.mem_nick LIKE CONCAT('%',#{search},'%')
                </when>
                <when test="gubun == 2">      <!-- DJ ID -->
                    AND b.mem_id LIKE CONCAT('%',#{search},'%')
                </when>
                <otherwise><!-- 방송제목 -->
                    AND a.title LIKE CONCAT('%',#{search},'%')
                </otherwise>
            </choose>
        </if>
        <if test='searchBroad != null and searchBroad != ""'>
            <choose>
                <when test="gubunBroad == 9999">      <!-- 전체 -->
                    AND (a.title LIKE CONCAT('%',#{searchBroad},'%')
                    OR a.msg_welcom LIKE CONCAT('%',#{searchBroad},'%')
                    OR a.notice LIKE CONCAT('%',#{searchBroad},'%'))
                </when>
                <when test="gubun == 1">      <!-- 방송제목 -->
                    AND a.title LIKE CONCAT('%',#{searchBroad},'%')
                </when>
                <when test="gubun == 2">      <!-- 인사말 -->
                    AND a.msg_welcom LIKE CONCAT('%',#{searchBroad},'%')
                </when>
                <otherwise>               <!-- 방송공지 -->
                    AND a.notice LIKE CONCAT('%',#{searchBroad},'%')
                </otherwise>
            </choose>
        </if>
    </select>
</mapper>