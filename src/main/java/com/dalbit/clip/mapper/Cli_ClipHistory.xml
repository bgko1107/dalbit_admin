<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.clip.dao.Cli_ClipHistoryDao">

    <!-- 클립 이력 조회 -->

    <sql id="clipHistoryCondition">
        <where>
            <if test="isChoiceDate != null and isChoiceDate != '' and isChoiceDate != '-1' ">
                AND clip.start_date
                BETWEEN
                    DATE_FORMAT(#{startDate}, '%Y-%m-%d 00:00:00')
                AND
                    DATE_FORMAT(#{endDate}, '%Y-%m-%d 23:59:59')
            </if>

            <if test='subjectType != null and subjectType != "" and subjectType != "-1"'>
                AND
                    clip.subject_type = #{subjectType}
            </if>

            <if test='search_testId != null and search_testId == "1"'>
                AND
                    clipInfo.inner = 0
            </if>

            <if test='searchText != null and searchText != ""'>
                <choose>
                    <when test='searchType == "1"'>
                        and clip.cast_no like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "2"'>
                        and clip.title like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "3"'>
                        and clip.mem_no like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "4"'>
                        and clipInfo.mem_userid like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "5"'>
                        and clipInfo.mem_nick like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "6"'>
                        and clipInfo.mem_phone like  concat ('%', #{searchText}, '%')
                    </when>
                    <otherwise>
                        and (
                            clip.cast_no like  concat ('%', #{searchText}, '%')
                            or clip.title like  concat ('%', #{searchText}, '%')
                            or clip.mem_no like  concat ('%', #{searchText}, '%')
                            or clipInfo.mem_userid like  concat ('%', #{searchText}, '%')
                            or clipInfo.mem_nick like  concat ('%', #{searchText}, '%')
                            or clipInfo.mem_phone like  concat ('%', #{searchText}, '%')
                        )
                    </otherwise>
                </choose>
            </if>

        </where>
    </sql>

    <select id="selectClipHistoryList" parameterType="com.dalbit.clip.vo.ClipHistoryVo" resultType="com.dalbit.clip.vo.ClipHistoryVo">
        /* Cli_ClipHistory.xml - selectClipHistoryList*/
        select
            @rownum := @rownum + 1 as rowNum,
            a.*
        from (
            SELECT
                a.*
            FROM
            (
                SELECT
                    clip.idx AS clipIdx
                    , clip.cast_no AS castNo
                    , clip.subject_type AS subjectType
                    , code.code AS subjectName
                    , clip.title AS title
                    , clip.type_entry AS typeEntry
                    , clip.image_background AS imageBackground
                    , clip.file_name AS fileName
                    , clip.file_path AS filePath
                    , clip.file_play AS filePlay
                    , clip.mem_no AS memNo
                    , clipInfo.mem_sex AS memSex
                    , clipInfo.mem_birth_year AS memBirthYear
                    , clipInfo.mem_nick AS memNick
                    , clip.type_open AS typeOpen
                    , clip.state AS state
                    , clip.hide AS hide
                    , clip.code_link AS codeLink
                    , clip.count_play AS countPlay
                    , clip.count_good AS countGood
                    , clip.count_gift AS countGift
                    , clip.count_byeol AS countByeol
                    , clip.start_date AS startDate
                    , clip.end_date AS endDate
                    , clip.badge_newdj AS badgeNewdj
                    , clip.os_type AS osType
                    , clip.last_upd_date AS lastUpdDate
                    , (SELECT COUNT(*) FROM rd_data.tb_cast_room WHERE mem_no = clip.mem_no) AS memInsertCnt
                    , clipInfo.`inner` AS 'inner'
                    , (SELECT COUNT(*) FROM rd_data.tb_cast_room_board WHERE cast_no = clip.cast_no) AS replyCnt
                FROM rd_data.tb_cast_room clip
                LEFT JOIN
                    rd_data.tb_member_basic clipInfo
                ON
                    clipInfo.mem_no = clip.mem_no
                LEFT JOIN
                    rd_data.tbl_code_define code
                ON
                    code.type = 'clip_type' AND clip.subject_type = code.value
                <include refid="clipHistoryCondition"/>
            ) as a
            <if test='orderByType != null and orderByType != ""'>
                <choose>
                    <when test="orderByType == 0 ">  <!-- 누적 등록 글 순 -->
                        order by a.startDate desc
                    </when>
                    <when test="orderByType == 1 ">  <!-- 누적 등록 글 순 -->
                        order by a.memInsertCnt desc, a.startDate desc
                    </when>
                    <when test="orderByType == 2 ">  <!-- 좋아요 많은 순 -->
                        order by  a.countGood desc
                    </when>
                    <when test="orderByType == 3 "> <!-- 청취 많은 순 -->
                        order by a.countPlay desc
                    </when>
                    <otherwise>
                        order by a.startDate desc
                    </otherwise>
                </choose>
            </if>
            limit #{pageStart}, #{pageCnt}
        ) a
        , (select @rownum := #{pageStart}) r
    </select>

    <select id="selectClipHistoryListCnt" parameterType="com.dalbit.clip.vo.ClipHistoryVo" resultType="integer">
        /* Cli_ClipHistory.xml - selectClipHistoryListCnt*/
        select
            COUNT(*)
        from (
            SELECT
                clip.idx AS clipIdx
                , clip.cast_no AS castNo
                , clip.subject_type AS subjectType
                , code.code AS subjectName
                , clip.title AS title
                , clip.type_entry AS typeEntry
                , clip.image_background AS imageBackground
                , clip.file_name AS fileName
                , clip.file_path AS filePath
                , clip.file_play AS filePlay
                , clip.mem_no AS memNo
                , clipInfo.mem_sex AS memSex
                , clipInfo.mem_birth_year AS memBirthYear
                , clipInfo.mem_nick AS memNick
                , clip.type_open AS typeOpen
                , clip.state AS state
                , clip.hide AS hide
                , clip.code_link AS codeLink
                , clip.count_play AS countPlay
                , clip.count_good AS countGood
                , clip.count_gift AS countGift
                , clip.count_byeol AS countByeol
                , clip.start_date AS startDate
                , clip.end_date AS endDate
                , clip.badge_newdj AS badgeNewdj
                , clip.os_type AS osType
                , clip.last_upd_date AS lastUpdDate
                , (SELECT COUNT(*) FROM rd_data.tb_cast_room WHERE mem_no = clip.mem_no) AS memInsertCnt
                , clipInfo.`inner` AS 'inner'
                , (SELECT COUNT(*) FROM rd_data.tb_cast_room_board WHERE cast_no = clip.cast_no) AS replyCnt
            FROM rd_data.tb_cast_room clip
            LEFT JOIN
                rd_data.tb_member_basic clipInfo
            ON
                clipInfo.mem_no = clip.mem_no
            LEFT JOIN
                rd_data.tbl_code_define code
            ON
                code.type = 'clip_type' AND clip.subject_type = code.value
            <include refid="clipHistoryCondition"/>
        ) a
    </select>


    <select id="callClipHistoryList" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.clip.vo.ClipHistoryVo">
        call rd_admin.sp_admin_clip_history(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>


    <!-- 클립 이력(회원) 조회 -->
    <select id="callClipHistoryMemberList" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.clip.vo.ClipHistoryMemberVo">
        call rd_admin.sp_admin_clip_member_history(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>


    <!-- 클립 숨김 처리 -->
    <update id="updateHide" parameterType="com.dalbit.clip.vo.ClipHistoryVo">
    /* Cli_ClipHistory.xml - updateHide*/
        UPDATE rd_data.tb_cast_room
        SET
          hide = #{hide}
        WHERE
          cast_no = #{castNo}
    </update>

    <!-- 클립 삭제 처리 -->
    <update id="deleteClip" parameterType="com.dalbit.clip.vo.ClipHistoryVo">
    /* Cli_ClipHistory.xml - clipRemove*/
        UPDATE rd_data.tb_cast_room
        SET
          end_date = NOW()
          ,state = 5
        WHERE
          cast_no = #{castNo}
    </update>

    <!-- 클립 어드미 수정 이력등록 -->
    <insert id="insertClipEditHistory" parameterType="com.dalbit.clip.vo.ClipEditHistoryVo">
        /* Cli_ClipHistory.xml - insertClipEditHistory */
        INSERT INTO rd_admin.tb_clip_edit_history(
            edit_contents
            , edit_type
            , last_upd_date
            , op_name
            , cast_no
        ) values(
            #{edit_contents}
            , #{edit_type}
            , now()
            , #{op_name}
            , #{castNo}
        )
    </insert>







    <!-- 클립 댓글 리스트 조회 -->

    <sql id="clipHistoryReplyCondition">
        <where>
            cast_no = #{targetClipNo}

            <if test="isChoiceDate != null and isChoiceDate != '' and isChoiceDate != '-1' ">
                AND borad.write_date
                BETWEEN
                DATE_FORMAT(#{startDate}, '%Y-%m-%d 00:00:00')
                AND
                DATE_FORMAT(#{endDate}, '%Y-%m-%d 23:59:59')
            </if>

            <if test='search_testId != null and search_testId == "1"'>
                AND
                basic.`inner` = 0
            </if>

            <if test='searchText != null and searchText != ""'>
                <choose>
                    <when test='searchType == "3"'>
                        and clip.mem_no like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "4"'>
                        and clipInfo.mem_userid like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "5"'>
                        and clipInfo.mem_nick like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "6"'>
                        and clipInfo.mem_phone like  concat ('%', #{searchText}, '%')
                    </when>
                    <otherwise>
                        and (
                        IFNULL( basic.mem_no, basicWd.mem_no) like  concat ('%', #{searchText}, '%')
                        or IFNULL( basic.mem_userid, basicWd.mem_userid) like  concat ('%', #{searchText}, '%')
                        or IFNULL( basic.mem_nick, basicWd.mem_nick) like  concat ('%', #{searchText}, '%')
                        or IFNULL( basic.mem_phone, basicWd.mem_phone) like  concat ('%', #{searchText}, '%')
                        )
                    </otherwise>
                </choose>
            </if>

        </where>
    </sql>

    <select id="selectReplyList" parameterType="com.dalbit.clip.vo.ClipHistoryReplyVo" resultType="com.dalbit.clip.vo.ClipHistoryReplyVo">
        select
            @rownum := @rownum + 1 as rowNum,
            a.*
        from (
            SELECT
                a.*
            FROM
            (
                SELECT
                    borad.idx	AS replyIdx
                    , borad.cast_no	AS castNo
                    , borad.cast_mem_no	AS castMemNo
                    , borad.writer_mem_no	AS writerMemNo
                    , borad.contents	AS contents
                    , borad.status	AS status
                    , borad.write_date	AS writeDate
                    , borad.last_upd_date	AS lastUpdDate
                    , IFNULL( basic.mem_nick, basicWd.mem_nick) AS memNick
                    , IFNULL( basic.mem_sex, basicWd.mem_sex) AS memSex
                    , IFNULL( basic.mem_birth_year, basicWd.mem_birth_year) AS memBirthYear
                    , profile.image_profile AS profileImage
                    , (SELECT COUNT(*) FROM rd_data.tb_cast_room_board WHERE cast_no = #{castNo} AND writer_mem_no = borad.writer_mem_no) AS replyWriteCnt
                    , basic.`inner` AS `inner`
                FROM
                    rd_data.tb_cast_room_board borad
                LEFT JOIN
                    rd_data.tb_member_basic basic
                ON
                    basic.mem_no = borad.writer_mem_no
                LEFT JOIN
                    rd_data.tb_member_withdrawal_bak basicWd
                ON
                    basicWd.mem_no = borad.writer_mem_no
                LEFT JOIN
                    rd_data.tb_member_profile profile
                ON
                    profile.mem_no = borad.writer_mem_no
                <include refid="clipHistoryReplyCondition"></include>
            ) a
            ORDER BY
                a.writeDate DESC
            limit #{pageStart}, #{pageCnt}
          ) a
        , (select @rownum := #{pageStart}) r
    </select>

    <select id="selectReplySummary" parameterType="com.dalbit.clip.vo.ClipHistoryReplyVo" resultType="com.dalbit.clip.vo.ClipHistoryTotalVo">
        SELECT
            COUNT(*) AS totalCnt
            , SUM( IF( IFNULL( basic.mem_sex, basicWd.mem_sex ) = 'm' , 1 , 0 ) ) AS manTotalCnt
            , SUM( IF( IFNULL( basic.mem_sex, basicWd.mem_sex ) = 'f' , 1 , 0 ) ) AS femaleTotalCnt
            , SUM( IF( IFNULL( basic.mem_sex, basicWd.mem_sex ) = 'n' , 1 , 0 ) ) AS unknownTotalCnt
        FROM
            rd_data.tb_cast_room_board borad
        LEFT JOIN
            rd_data.tb_member_basic basic
        ON
            basic.mem_no = borad.writer_mem_no
        LEFT JOIN
            rd_data.tb_member_withdrawal_bak basicWd
        ON
            basicWd.mem_no = borad.writer_mem_no
        <include refid="clipHistoryReplyCondition"></include>
        ORDER BY
            write_date DESC
    </select>


    <!-- 클립 청취 이력 조회 -->

    <sql id="clipHistoryListenCondition">
        <where>
            <if test="isChoiceDate != null and isChoiceDate != '' and isChoiceDate != '-1' ">
                AND listen.last_upd_date
                BETWEEN
                DATE_FORMAT(#{startDate}, '%Y-%m-%d 00:00:00')
                AND
                DATE_FORMAT(#{endDate}, '%Y-%m-%d 23:59:59')
            </if>

            <if test='search_testId != null and search_testId == "1"'>
                AND
                clipInfo.inner = 0
            </if>

            <if test='searchText != null and searchText != ""'>
                <choose>
                    <when test='searchType == "1"'>
                        AND clip.cast_no like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "2"'>
                        AND clip.title like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "3"'>
                        AND listen.mem_no like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "4"'>
                        AND listenInfo.mem_userid like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "5"'>
                        AND listenInfo.mem_nick like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "6"'>
                        AND listenInfo.mem_phone like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "7"'>
                        AND listenInfo.ip like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "8"'>
                        AND clip.mem_no like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "9"'>
                        AND clipInfo.mem_userid like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "10"'>
                        AND clipInfo.mem_nick like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "11"'>
                        AND clipInfo.mem_phone like  concat ('%', #{searchText}, '%')
                    </when>
                    <otherwise>
                        and (
                            clip.cast_no like  concat ('%', #{searchText}, '%')
                            OR clip.title like  concat ('%', #{searchText}, '%')
                            OR listen.mem_no like  concat ('%', #{searchText}, '%')
                            OR listenInfo.mem_userid like  concat ('%', #{searchText}, '%')
                            OR listenInfo.mem_nick like  concat ('%', #{searchText}, '%')
                            OR listenInfo.mem_phone like  concat ('%', #{searchText}, '%')
                            OR listenInfo.ip like  concat ('%', #{searchText}, '%')
                            OR clip.mem_no like  concat ('%', #{searchText}, '%')
                            OR clipInfo.mem_userid like  concat ('%', #{searchText}, '%')
                            OR clipInfo.mem_nick like  concat ('%', #{searchText}, '%')
                            OR clipInfo.mem_phone like  concat ('%', #{searchText}, '%')
                        )
                    </otherwise>
                </choose>
            </if>


        </where>
    </sql>

    <select id="selectClipHistoryListenList" parameterType="com.dalbit.clip.vo.ClipHistoryListenVo" resultType="com.dalbit.clip.vo.ClipHistoryListenVo">
        /* Cli_ClipHistory.xml - selectClipHistoryListenList*/
        select
        @rownum := @rownum + 1 as rowNum,
        a.*
        from (
            SELECT
                a.*
            FROM
            (
                SELECT
                    listen.last_upd_date AS listenDate
                    , listen.mem_no AS listenMemNo
                    , listenInfo.mem_nick AS listenMemNick
                    , listenInfo.mem_sex AS listenMemSex
                    , listenInfo.mem_birth_year AS listenMemBirthYear
                    , listenInfo.ip AS listenMemIp
                    , clip.idx AS clipIdx
                    , clip.cast_no AS castNo
                    , clip.subject_type AS subjectType
                    , code.code AS subjectName
                    , clip.title AS title
                    , clip.type_entry AS typeEntry
                    , clip.image_background AS imageBackground
                    , clip.file_name AS fileName
                    , clip.file_path AS filePath
                    , clip.file_play AS filePlay
                    , clip.mem_no AS memNo
                    , clipInfo.mem_sex AS memSex
                    , clipInfo.mem_birth_year AS memBirthYear
                    , clipInfo.mem_nick AS memNick
                    , clip.type_open AS typeOpen
                    , clip.state AS state
                    , clip.hide AS hide
                    , clip.code_link AS codeLink
                    , clip.count_play AS countPlay
                    , clip.count_good AS countGood
                    , clip.count_gift AS countGift
                    , clip.count_byeol AS countByeol
                    , clip.start_date AS startDate
                    , clip.end_date AS endDate
                    , clip.badge_newdj AS badgeNewdj
                    , clip.os_type AS osType
                    , clip.last_upd_date AS lastUpdDate
                    , clipInfo.`inner` AS 'inner'
                    , wallet.ruby AS dal
                FROM
                    rd_data.tb_cast_room_member listen
                LEFT JOIN
                    rd_data.tb_cast_room clip
                ON
                    listen.cast_no = clip.cast_no
                LEFT JOIN
                    rd_data.tb_member_basic listenInfo
                ON
                    listen.mem_no = listenInfo.mem_no
                LEFT JOIN
                    rd_data.tb_member_basic clipInfo
                ON
                    listen.cast_mem_no = clipInfo.mem_no
                LEFT JOIN
                    rd_data.tbl_code_define code
                ON
                    code.type = 'clip_type' AND clip.subject_type = code.value
                LEFT JOIN
                    rd_data.tb_member_wallet wallet
                ON
                    listen.cast_mem_no = wallet.mem_no
                <include refid="clipHistoryListenCondition"/>
            ) a
                order by a.listenDate desc
                limit #{pageStart}, #{pageCnt}
        ) a
        , (select @rownum := #{pageStart}) r
    </select>

    <select id="selectClipHistoryListenListCnt" parameterType="com.dalbit.clip.vo.ClipHistoryListenVo" resultType="integer">
        /* Cli_ClipHistory.xml - selectClipHistoryListCnt*/
        select
        COUNT(*)
        from (
            SELECT
                listen.last_upd_date AS listenDate
                , listen.mem_no AS listenMemNo
                , listenInfo.mem_nick AS listenMemNick
                , listenInfo.mem_sex AS listenMemSex
                , listenInfo.mem_birth_year AS listenMemBirthYear
                , listenInfo.ip AS listenMemIp
                , clip.idx AS clipIdx
                , clip.cast_no AS castNo
                , clip.subject_type AS subjectType
                , code.code AS subjectName
                , clip.title AS title
                , clip.type_entry AS typeEntry
                , clip.image_background AS imageBackground
                , clip.file_name AS fileName
                , clip.file_path AS filePath
                , clip.file_play AS filePlay
                , clip.mem_no AS memNo
                , clipInfo.mem_sex AS memSex
                , clipInfo.mem_birth_year AS memBirthYear
                , clipInfo.mem_nick AS memNick
                , clip.type_open AS typeOpen
                , clip.state AS state
                , clip.hide AS hide
                , clip.code_link AS codeLink
                , clip.count_play AS countPlay
                , clip.count_good AS countGood
                , clip.count_gift AS countGift
                , clip.count_byeol AS countByeol
                , clip.start_date AS startDate
                , clip.end_date AS endDate
                , clip.badge_newdj AS badgeNewdj
                , clip.os_type AS osType
                , clip.last_upd_date AS lastUpdDate
                , clipInfo.`inner` AS 'inner'
            FROM
                rd_data.tb_cast_room_member listen
            LEFT JOIN
                rd_data.tb_cast_room clip
            ON
                listen.cast_no = clip.cast_no
            LEFT JOIN
                rd_data.tb_member_basic listenInfo
            ON
                listen.mem_no = listenInfo.mem_no
            LEFT JOIN
                rd_data.tb_member_basic clipInfo
            ON
                listen.cast_mem_no = clipInfo.mem_no
            LEFT JOIN
                rd_data.tbl_code_define code
            ON
                code.type = 'clip_type' AND clip.subject_type = code.value
            <include refid="clipHistoryListenCondition"/>
        ) a
    </select>


    <select id="selectClipHistoryListenTotalCnt" parameterType="com.dalbit.clip.vo.ClipHistoryListenVo" resultType="com.dalbit.clip.vo.ClipHistoryTotalVo">
        /* Cli_ClipHistory.xml - selectClipHistoryListenTotalCnt*/
        SELECT
            SUM(IF(listenInfo.mem_sex = 'm', 1, 0)) AS manTotalCnt
            , SUM(IF(listenInfo.mem_sex = 'f', 1, 0)) AS femaleTotalCnt
            , SUM(IF(listenInfo.mem_sex = 'n', 1, 0)) AS unknownTotalCnt
        FROM
            rd_data.tb_cast_room_member listen
        LEFT JOIN
            rd_data.tb_cast_room clip
        ON
            listen.cast_no = clip.cast_no
        LEFT JOIN
            rd_data.tb_member_basic listenInfo
        ON
            listen.mem_no = listenInfo.mem_no
        <include refid="clipHistoryListenCondition"/>
    </select>


    <select id="callClipHistoryListenList" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.clip.vo.ClipHistoryListenVo">
        call rd_admin.sp_admin_clip_listen_history(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>




    <!-- 클립 좋아요 이력 조회 -->

    <sql id="clipHistoryGoodCondition">
        <where>
            listen.good != 0

            <if test="targetClipNo != null and targetClipNo != ''">
                AND listen.cast_no = #{targetClipNo}
            </if>

            <if test="isChoiceDate != null and isChoiceDate != '' and isChoiceDate != '-1' ">
                AND listen.good_date
                BETWEEN
                DATE_FORMAT(#{startDate}, '%Y-%m-%d 00:00:00')
                AND
                DATE_FORMAT(#{endDate}, '%Y-%m-%d 23:59:59')
            </if>

            <if test='search_testId != null and search_testId == "1"'>
                AND
                clipInfo.inner = 0
            </if>

            <if test='searchText != null and searchText != ""'>
                <choose>
                    <when test='searchType == "1"'>
                        AND clip.cast_no like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "2"'>
                        AND clip.title like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "3"'>
                        AND listen.mem_no like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "4"'>
                        AND listenInfo.mem_userid like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "5"'>
                        AND listenInfo.mem_nick like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "6"'>
                        AND listenInfo.mem_phone like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "7"'>
                        AND listenInfo.ip like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "8"'>
                        AND clip.mem_no like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "9"'>
                        AND clipInfo.mem_userid like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "10"'>
                        AND clipInfo.mem_nick like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "11"'>
                        AND clipInfo.mem_phone like  concat ('%', #{searchText}, '%')
                    </when>
                    <otherwise>
                        and (
                        clip.cast_no like  concat ('%', #{searchText}, '%')
                        OR clip.title like  concat ('%', #{searchText}, '%')
                        OR listen.mem_no like  concat ('%', #{searchText}, '%')
                        OR listenInfo.mem_userid like  concat ('%', #{searchText}, '%')
                        OR listenInfo.mem_nick like  concat ('%', #{searchText}, '%')
                        OR listenInfo.mem_phone like  concat ('%', #{searchText}, '%')
                        OR listenInfo.ip like  concat ('%', #{searchText}, '%')
                        OR clip.mem_no like  concat ('%', #{searchText}, '%')
                        OR clipInfo.mem_userid like  concat ('%', #{searchText}, '%')
                        OR clipInfo.mem_nick like  concat ('%', #{searchText}, '%')
                        OR clipInfo.mem_phone like  concat ('%', #{searchText}, '%')
                        )
                    </otherwise>
                </choose>
            </if>


        </where>
    </sql>

    <select id="callClipHistoryGoodList" parameterType="com.dalbit.clip.vo.ClipHistoryListenVo" resultType="com.dalbit.clip.vo.ClipHistoryListenVo">
        /* Cli_ClipHistory.xml - callClipHistoryGoodList*/
        select
        @rownum := @rownum + 1 as rowNum,
        a.*
        from (
        SELECT
        a.*
        FROM
        (
        SELECT
        listen.last_upd_date AS listenDate
        , listen.good_date AS listenGoodDate
        , listen.mem_no AS listenMemNo
        , listenInfo.mem_nick AS listenMemNick
        , listenInfo.mem_sex AS listenMemSex
        , listenInfo.mem_birth_year AS listenMemBirthYear
        , listenInfo.ip AS listenMemIp
        , clip.idx AS clipIdx
        , clip.cast_no AS castNo
        , clip.subject_type AS subjectType
        , code.code AS subjectName
        , clip.title AS title
        , clip.type_entry AS typeEntry
        , clip.image_background AS imageBackground
        , clip.file_name AS fileName
        , clip.file_path AS filePath
        , clip.file_play AS filePlay
        , clip.mem_no AS memNo
        , clipInfo.mem_sex AS memSex
        , clipInfo.mem_birth_year AS memBirthYear
        , clipInfo.mem_nick AS memNick
        , clip.type_open AS typeOpen
        , clip.state AS state
        , clip.hide AS hide
        , clip.code_link AS codeLink
        , clip.count_play AS countPlay
        , clip.count_good AS countGood
        , clip.count_gift AS countGift
        , clip.count_byeol AS countByeol
        , clip.start_date AS startDate
        , clip.end_date AS endDate
        , clip.badge_newdj AS badgeNewdj
        , clip.os_type AS osType
        , clip.last_upd_date AS lastUpdDate
        , clipInfo.`inner` AS 'inner'
        , wallet.ruby AS dal
        FROM
        rd_data.tb_cast_room_member listen
        LEFT JOIN
        rd_data.tb_cast_room clip
        ON
        listen.cast_no = clip.cast_no
        LEFT JOIN
        rd_data.tb_member_basic listenInfo
        ON
        listen.mem_no = listenInfo.mem_no
        LEFT JOIN
        rd_data.tb_member_basic clipInfo
        ON
        listen.cast_mem_no = clipInfo.mem_no
        LEFT JOIN
        rd_data.tbl_code_define code
        ON
        code.type = 'clip_type' AND clip.subject_type = code.value
        LEFT JOIN
        rd_data.tb_member_wallet wallet
        ON
        listen.cast_mem_no = wallet.mem_no
        <include refid="clipHistoryGoodCondition"/>
        ) a
        order by a.listenDate desc
        limit #{pageStart}, #{pageCnt}
        ) a
        , (select @rownum := #{pageStart}) r
    </select>

    <select id="callClipHistoryGoodListCnt" parameterType="com.dalbit.clip.vo.ClipHistoryListenVo" resultType="integer">
        /* Cli_ClipHistory.xml - callClipHistoryGoodListCnt*/
        select
        COUNT(*)
        from (
        SELECT
        listen.last_upd_date AS listenDate
        , listen.good_date AS listenGoodDate
        , listen.mem_no AS listenMemNo
        , listenInfo.mem_nick AS listenMemNick
        , listenInfo.mem_sex AS listenMemSex
        , listenInfo.mem_birth_year AS listenMemBirthYear
        , listenInfo.ip AS listenMemIp
        , clip.idx AS clipIdx
        , clip.cast_no AS castNo
        , clip.subject_type AS subjectType
        , code.code AS subjectName
        , clip.title AS title
        , clip.type_entry AS typeEntry
        , clip.image_background AS imageBackground
        , clip.file_name AS fileName
        , clip.file_path AS filePath
        , clip.file_play AS filePlay
        , clip.mem_no AS memNo
        , clipInfo.mem_sex AS memSex
        , clipInfo.mem_birth_year AS memBirthYear
        , clipInfo.mem_nick AS memNick
        , clip.type_open AS typeOpen
        , clip.state AS state
        , clip.hide AS hide
        , clip.code_link AS codeLink
        , clip.count_play AS countPlay
        , clip.count_good AS countGood
        , clip.count_gift AS countGift
        , clip.count_byeol AS countByeol
        , clip.start_date AS startDate
        , clip.end_date AS endDate
        , clip.badge_newdj AS badgeNewdj
        , clip.os_type AS osType
        , clip.last_upd_date AS lastUpdDate
        , clipInfo.`inner` AS 'inner'
        FROM
        rd_data.tb_cast_room_member listen
        LEFT JOIN
        rd_data.tb_cast_room clip
        ON
        listen.cast_no = clip.cast_no
        LEFT JOIN
        rd_data.tb_member_basic listenInfo
        ON
        listen.mem_no = listenInfo.mem_no
        LEFT JOIN
        rd_data.tb_member_basic clipInfo
        ON
        listen.cast_mem_no = clipInfo.mem_no
        LEFT JOIN
        rd_data.tbl_code_define code
        ON
        code.type = 'clip_type' AND clip.subject_type = code.value
        <include refid="clipHistoryGoodCondition"/>
        ) a
    </select>


    <select id="callClipHistoryGoodTotal" parameterType="com.dalbit.clip.vo.ClipHistoryListenVo" resultType="com.dalbit.clip.vo.ClipHistoryTotalVo">
        /* Cli_ClipHistory.xml - callClipHistoryGoodTotal*/
        SELECT
        SUM(IF(listenInfo.mem_sex = 'm', 1, 0)) AS manTotalCnt
        , SUM(IF(listenInfo.mem_sex = 'f', 1, 0)) AS femaleTotalCnt
        , SUM(IF(listenInfo.mem_sex = 'n', 1, 0)) AS unknownTotalCnt
        FROM
        rd_data.tb_cast_room_member listen
        LEFT JOIN
        rd_data.tb_cast_room clip
        ON
        listen.cast_no = clip.cast_no
        LEFT JOIN
        rd_data.tb_member_basic listenInfo
        ON
        listen.mem_no = listenInfo.mem_no
        <include refid="clipHistoryGoodCondition"/>
    </select>






    <!-- 클립 선물 이력 조회 -->
    <select id="callClipHistoryGiftList" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.clip.vo.ClipHistoryGiftVo">
        call rd_admin.sp_admin_clip_gift_history(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>


    <sql id="clipHistoryRemoveCondition">
        <where>
            clip.state = 4
            <if test="isChoiceDate != null and isChoiceDate != '' and isChoiceDate != '-1' ">
                AND clip.last_upd_date
                BETWEEN
                DATE_FORMAT(#{startDate}, '%Y-%m-%d 00:00:00')
                AND
                DATE_FORMAT(#{endDate}, '%Y-%m-%d 23:59:59')
            </if>

            <if test='search_testId != null and search_testId == "1"'>
                AND
                clipInfo.inner = 0
            </if>

            <if test='searchText != null and searchText != ""'>
                <choose>
                    <when test='searchType == "1"'>
                        and clip.cast_no like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "2"'>
                        and clip.title like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "3"'>
                        and clip.mem_no like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "4"'>
                        and clipInfo.mem_userid like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "5"'>
                        and clipInfo.mem_nick like  concat ('%', #{searchText}, '%')
                    </when>
                    <when test='searchType == "6"'>
                        and clipInfo.mem_phone like  concat ('%', #{searchText}, '%')
                    </when>
                    <otherwise>
                        and (
                        clip.cast_no like  concat ('%', #{searchText}, '%')
                        or clip.title like  concat ('%', #{searchText}, '%')
                        or clip.mem_no like  concat ('%', #{searchText}, '%')
                        or clipInfo.mem_userid like  concat ('%', #{searchText}, '%')
                        or clipInfo.mem_nick like  concat ('%', #{searchText}, '%')
                        or clipInfo.mem_phone like  concat ('%', #{searchText}, '%')
                        )
                    </otherwise>
                </choose>
            </if>

        </where>
    </sql>

    <select id="selectClipHistoryRemoveList" parameterType="com.dalbit.clip.vo.ClipHistoryRemoveVo" resultType="com.dalbit.clip.vo.ClipHistoryRemoveVo">
        /* Cli_ClipHistory.xml - selectClipHistoryListenList*/
        select
        @rownum := @rownum + 1 as rowNum,
        a.*
        from (
            SELECT
                a.*
            FROM
            (
                SELECT
                     clip.idx AS clipIdx
                    , clip.cast_no AS castNo
                    , clip.subject_type AS subjectType
                    , code.code AS subjectName
                    , clip.title AS title
                    , clip.type_entry AS typeEntry
                    , clip.image_background AS imageBackground
                    , clip.file_name AS fileName
                    , clip.file_path AS filePath
                    , clip.file_play AS filePlay
                    , clip.mem_no AS memNo
                    , clipInfo.mem_sex AS memSex
                    , clipInfo.mem_birth_year AS memBirthYear
                    , clipInfo.mem_nick AS memNick
                    , clip.type_open AS typeOpen
                    , clip.state AS state
                    , clip.hide AS hide
                    , clip.code_link AS codeLink
                    , clip.count_play AS countPlay
                    , clip.count_good AS countGood
                    , clip.count_gift AS countGift
                    , clip.count_byeol AS countByeol
                    , clip.start_date AS startDate
                    , clip.end_date AS endDate
                    , clip.badge_newdj AS badgeNewdj
                    , clip.os_type AS osType
                    , clip.last_upd_date AS lastUpdDate
                    , clipInfo.`inner` AS 'inner'
                    , wallet.ruby AS dal
                    , clipEdit.op_name AS opName
                FROM
                    rd_data.tb_cast_room clip
                LEFT JOIN
                    rd_data.tb_member_basic clipInfo
                ON
                    clip.mem_no = clipInfo.mem_no
                LEFT JOIN
                    rd_data.tbl_code_define code
                ON
                    code.type = 'clip_type' AND clip.subject_type = code.value
                LEFT JOIN
                    rd_data.tb_member_wallet wallet
                ON
                    clip.mem_no = wallet.mem_no
                LEFT JOIN
                    rd_admin.tb_clip_edit_history clipEdit
                ON
                    clipEdit.edit_type = 4 AND clipEdit.cast_no = clip.cast_no
                <include refid="clipHistoryRemoveCondition"/>
            ) a
            order by a.endDate desc
            limit #{pageStart}, #{pageCnt}
        ) a
        , (select @rownum := #{pageStart}) r
    </select>

    <select id="selectClipHistoryRemoveListCnt" parameterType="com.dalbit.clip.vo.ClipHistoryRemoveVo" resultType="integer">
        /* Cli_ClipHistory.xml - selectClipHistoryListCnt*/
        select
        COUNT(*)
        from (
            SELECT
                 clip.idx AS clipIdx
                , clip.cast_no AS castNo
                , clip.subject_type AS subjectType
                , code.code AS subjectName
                , clip.title AS title
                , clip.type_entry AS typeEntry
                , clip.image_background AS imageBackground
                , clip.file_name AS fileName
                , clip.file_path AS filePath
                , clip.file_play AS filePlay
                , clip.mem_no AS memNo
                , clipInfo.mem_sex AS memSex
                , clipInfo.mem_birth_year AS memBirthYear
                , clipInfo.mem_nick AS memNick
                , clip.type_open AS typeOpen
                , clip.state AS state
                , clip.hide AS hide
                , clip.code_link AS codeLink
                , clip.count_play AS countPlay
                , clip.count_good AS countGood
                , clip.count_gift AS countGift
                , clip.count_byeol AS countByeol
                , clip.start_date AS startDate
                , clip.end_date AS endDate
                , clip.badge_newdj AS badgeNewdj
                , clip.os_type AS osType
                , clip.last_upd_date AS lastUpdDate
                , clipInfo.`inner` AS 'inner'
                , wallet.ruby AS dal
            FROM
                rd_data.tb_cast_room clip
            LEFT JOIN
                rd_data.tb_member_basic clipInfo
            ON
                clip.mem_no = clipInfo.mem_no
            LEFT JOIN
                rd_data.tbl_code_define code
            ON
                code.type = 'clip_type' AND clip.subject_type = code.value
            LEFT JOIN
                rd_data.tb_member_wallet wallet
            ON
                clip.mem_no = wallet.mem_no
            <include refid="clipHistoryRemoveCondition"/>
        ) a
    </select>

    <select id="callClipHistoryRemoveList" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.clip.vo.ClipHistoryRemoveVo">
        call rd_admin.sp_admin_clip_remove_history(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>




    <!-- 클립 상세정보 조회 -->
    <select id="callAdminClipInfoDetail" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.common.vo.ProcedureVo">
        call rd_admin.sp_admin_clip_info_detail	(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <!-- 클립 상세정보 수정 -->
    <update id="callAdminClipInfoDetailEdit" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo">
        call rd_admin.sp_admin_clip_edit(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </update>

</mapper>