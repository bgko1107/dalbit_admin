<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.menu.dao.Men_RankDao" >

    <select id="callMainDjRanking" statementType="CALLABLE" parameterType="ProcedureVo" resultType="com.dalbit.menu.vo.procedure.P_MainDjRankingVo">
        call rd_data.sp_ranking_dj(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callMainFanRanking" statementType="CALLABLE" parameterType="ProcedureVo" resultType="com.dalbit.menu.vo.procedure.P_MainFanRankingVo">
        call rd_data.sp_ranking_fan(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="getDjLiveCheck" parameterType="com.dalbit.menu.vo.DjRankingVo" resultType="com.dalbit.menu.vo.DjRankingVo">
        /* Men_Rank.xml - getDjLiveCheck */
        select count(*) as liveCnt, max(ranking_date) as liveDate from rd_data.tb_ranking_dj_live where date_format(ranking_date,'%Y.%m.%d') = #{sDate}
    </select>

    <select id="getFanLiveCheck" parameterType="com.dalbit.menu.vo.FanRankingVo" resultType="com.dalbit.menu.vo.FanRankingVo">
        /* Men_Rank.xml - getFanLiveCheck */
        select count(*) as liveCnt, max(ranking_date) as liveDate from rd_data.tb_ranking_fan_live where date_format(ranking_date,'%Y.%m.%d') = #{sDate}
    </select>

    <sql id="djCondition">
        select *, @RNUM := @RNUM + 1 as rowNum
            from (select
                      dj.rank as djRank
                    , dj.up_down as upDown
                    , dj.mem_no as memNo
                    , prof.image_profile as image_profile
                    , mem.mem_id as mem_id
                    , lev.`level` as `level`
                    , lev.grade as grade
                    , mem.mem_nick as mem_nick
                    , mem.mem_sex as mem_sex
                    , (select sum(ifnull(money,0)) from rd_data.tb_member_wallet where mem_no = mem.mem_no) as money
                    , (select ifnull(sum(ifnull(gold, 0)), 0) from rd_data.tb_member_broadcast_item item where item.mem_no = mem.mem_no and item_type = 1) as byeol
                    , (select count(if(gifted_mem_no!=0, gifted_mem_no, null)) from rd_data.tb_member_broadcast_item where mem_no = mem.mem_no) as gifted_mem_no
                    , (select count(if(mem_no!=0, mem_no, null)) from rd_data.tb_member_broadcast_broadcasting where mem_no = mem.mem_no) as airCount
                    , (select min(start_date) from rd_data.tb_member_broadcast_broadcasting where mem_no = mem.mem_no) as start_date
                    , (select sum(ifnull(airtime,0)) from rd_data.tb_member_broadcast_broadcasting where mem_no = mem.mem_no) as airTime
                    , dj.ranking_date as ranking_date
                    , ROUND(dj.broadcast_point / 60) as broadCnt
                    , CAST(dj.good_point AS INT) as goodCnt
                    , CAST(dj.dj_point AS INT) AS rankPoint
                    , dj.listener_point as listenCnt
                  from
                    <if test='rankType == "1"'>
                        <if test='liveCnt != 0'>
                          rd_data.tb_ranking_dj_live dj
                        </if>
                        <if test='liveCnt == 0'>
                            rd_data.tb_ranking_dj_day dj
                        </if>
                    </if>
                    <if test='rankType == "2"'>
                        rd_data.tb_ranking_dj_week dj
                    </if>
                    <if test='rankType == "3"'>
                        rd_data.tb_ranking_dj_month dj
                    </if>
                    inner join rd_data.tb_member_profile prof on prof.mem_no = dj.mem_no
                    inner join  rd_data.tb_member_level lev on prof.mem_no = lev.mem_no
                    left join rd_data.tb_member_basic mem on prof.mem_no = mem.mem_no
                where
                    <if test='liveCnt != 0'>
                      ranking_date = #{liveDate}
                    </if>
                    <if test='liveCnt == 0'>
                      date_format(ranking_date,'%Y.%m.%d') = #{sDate}
                    </if>

                    <if test='txt_search != null and txt_search != ""'>
                        <choose>
                            <when test='selectGubun =="1"'>
                                and mem.mem_no like concat('%', #{txt_search}, '%')
                            </when>
                            <when test='selectGubun =="2"'>
                                and mem_id like concat('%', #{txt_search}, '%')
                            </when>
                            <when test='selectGubun =="3"'>
                                and mem_nick like concat('%', #{txt_search}, '%')
                            </when>
                            <when test='selectGubun =="4"'>
                                and mem.mem_phone like concat('%', #{txt_search}, '%')
                            </when>
                            <otherwise>
                                and (mem.mem_no like concat('%', #{txt_search}, '%')
                                or mem_id like concat('%', #{txt_search}, '%')
                                or mem_nick like concat('%', #{txt_search}, '%')
                                or mem.mem_phone like concat('%', #{txt_search}, '%'))
                            </otherwise>
                        </choose>
                    </if>
            ) a , (select @RNUM := 0) r
            order by djRank asc
    </sql>

    <sql id="fanCondition">
        select *, @RNUM := @RNUM + 1 as rowNum
           from (
                  select
                      fan.rank as fanRank
                    , fan.up_down as upDown
                    , prof.image_profile as image_profile
                    , mem.mem_id as mem_id
                    , mem.mem_no as mem_no
                    , lev.`level` as `level`
                    , lev.grade as grade
                    , mem.mem_nick as mem_nick
                    , mem.mem_sex as mem_sex
                    , (select sum(ifnull(money,0)) from rd_data.tb_member_wallet where mem_no = mem.mem_no) as money
                    , (select ifnull(sum(ifnull(gold, 0)), 0) from rd_data.tb_member_broadcast_item item where item.mem_no = mem.mem_no and item_type = 1) as byeol
                    , (select count(if(gifted_mem_no!=0, gifted_mem_no, null)) from rd_data.tb_member_broadcast_item where mem_no = mem.mem_no) as gifted_mem_no
                    , (select count(if(mem_no!=0, mem_no, null)) from rd_data.tb_member_broadcast_broadcasting where mem_no = mem.mem_no) as airCount
                    , (select min(start_date) from rd_data.tb_member_broadcast_broadcasting where mem_no = mem.mem_no) as start_date
                    , (select sum(ifnull(airtime,0)) from rd_data.tb_member_broadcast_broadcasting where mem_no = mem.mem_no) as airTime
                    , fan.ranking_date as ranking_date
                  from rd_data.tb_member_basic mem
                    , rd_data.tb_member_profile prof
                    , rd_data.tb_member_level lev
                    <if test='rankType == "1"'>
                        <if test='liveCnt != 0'>
                            ,rd_data.tb_ranking_fan_live fan
                        </if>
                        <if test='liveCnt == "0"'>
                            ,rd_data.tb_ranking_fan_day fan
                        </if>
                    </if>
                    <if test='rankType == "2"'>
                        , rd_data.tb_ranking_fan_week fan
                    </if>
                    <if test='rankType == "3"'>
                        , rd_data.tb_ranking_fan_month fan
                    </if>
                  where mem.mem_no = prof.mem_no
                        and mem.mem_no = lev.mem_no
                        and mem.mem_no = fan.mem_no
                        <if test='liveCnt != 0'>
                           and ranking_date = #{liveDate}
                        </if>
                        <if test='liveCnt == 0'>
                           and date_format(ranking_date,'%Y.%m.%d') = #{sDate}
                        </if>
                        <if test='txt_search != null and txt_search != ""'>
                            and (mem.mem_no like concat('%', #{txt_search}, '%')
                            or mem_id like concat('%', #{txt_search}, '%')
                            or mem_nick like concat('%', #{txt_search}, '%')
                            or mem.mem_phone like concat('%', #{txt_search}, '%'))
                        </if>
                ) a , (select @RNUM := 0) r
            order by fanRank asc
    </sql>
    <!-- DJ -->
    <select id="getMainDjRankingList" parameterType="com.dalbit.menu.vo.DjRankingVo" resultType="com.dalbit.menu.vo.DjRankingVo">
        /* Men_Rank.xml - getMainDjRankingList */
        select *
        from (
        <include refid="djCondition"/>
        ) b
        where rowNum between #{searchStartNo, jdbcType=INTEGER} and #{searchEndNo, jdbcType=INTEGER}
    </select>

    <select id="getMainDjRankingListCnt" parameterType="com.dalbit.menu.vo.DjRankingVo" resultType="integer">
        /* Men_Rank.xml - getMainDjRankingListCnt */
        select
        count(*)
        from (
        <include refid="djCondition"/>
        ) as tb
    </select>


    <!-- fan -->
    <select id="getMainFanRankingList" parameterType="com.dalbit.menu.vo.FanRankingVo" resultType="com.dalbit.menu.vo.FanRankingVo">
        /* Men_Rank.xml - getMainFanRankingList */
        select *
            from (
            <include refid="fanCondition"/>
            ) b
        where rowNum between #{searchStartNo, jdbcType=INTEGER} and #{searchEndNo, jdbcType=INTEGER}
    </select>

    <select id="getMainFanRankingListCnt" parameterType="com.dalbit.menu.vo.FanRankingVo" resultType="integer">
        /* Men_Rank.xml - getMainFanRankingListCnt */
        select
          count(*)
            from (
              <include refid="fanCondition"/>
            ) as tb
    </select>



    <select id="getDjRankingOutVo" parameterType="com.dalbit.menu.vo.DjRankingVo" resultType="com.dalbit.menu.vo.DjRankingVo">
        /* Men_Rank.xml - getDjRankingOutVo */
        select count(*) as broadCnt
              ,sum(airtime) as airtime
              ,sum((select count(*) From rd_data.tb_broadcast_room_member where room_no = a.room_no and auth != 3 and substr(mem_no,1,1) != 8)) as listenCnt
              ,sum((select count(*) From rd_data.tb_member_broadcast_listening where room_no = a.room_no and good=1)) as goodCnt
              ,(select ifnull(sum(ruby),0)
                  from rd_data.tb_member_broadcast_item
                 where gifted_mem_no = a.mem_no
                   and room_no in ( select room_no
                                      from rd_data.tb_broadcast_room
                                     where mem_no = a.mem_no
                                       and date_format(end_date,'%Y.%m.%d') <![CDATA[>=]]> #{sDate}
                                       and date_format(end_date,'%Y.%m.%d') <![CDATA[<=]]> #{eDate})
                ) as itemCnt
        <if test='rankType == "1"'>
            <if test='liveCnt != 0'>
                ,(select round(dj_point) from rd_data.tb_ranking_dj_live where date_format(ranking_date,'%Y.%m.%d') = #{sDate} and mem_no=a.mem_no) as rankPoint
            </if>
            <if test='liveCnt == "0"'>
                ,(select round(dj_point) from rd_data.tb_ranking_dj_day where date_format(ranking_date,'%Y.%m.%d') = #{sDate} and mem_no=a.mem_no) as rankPoint
            </if>
        </if>
        <if test='rankType == "2"'>
            ,(select round(dj_point) from rd_data.tb_ranking_dj_week where mem_no = a.mem_no and date_format(ranking_date,'%Y.%m.%d') =#{sDate}) as rankPoint
        </if>
        <if test='rankType == "3"'>
            ,(select round(dj_point) from rd_data.tb_ranking_dj_month where mem_no = a.mem_no and date_format(ranking_date,'%Y.%m.%d') = #{sDate}) as rankPoint
        </if>
        from rd_data.tb_broadcast_room a
        where a.mem_no=#{memNo}
        and date_format(a.end_date,'%Y.%m.%d') <![CDATA[>=]]> #{sDate}
        and date_format(a.end_date,'%Y.%m.%d') <![CDATA[<=]]> #{eDate}
    </select>

    <select id="getFanRankingOutVo" parameterType="com.dalbit.menu.vo.FanRankingVo" resultType="com.dalbit.menu.vo.FanRankingVo">
        /* Men_Rank.xml - getFanRankingOutVo */
        select count(*) listenCnt, sum(listentime) airtime, sum(good) as goodCnt
                ,(select ifnull(sum(ruby),0)
                    from rd_data.tb_member_broadcast_item
                   where mem_no = a.mem_no
                     and room_no in ( select room_no
                                        from rd_data.tb_broadcast_room
                                       where mem_no = a.mem_no
                                         and date_format(end_date,'%Y.%m.%d') <![CDATA[>=]]> #{sDate}
                                         and date_format(end_date,'%Y.%m.%d') <![CDATA[<=]]> #{eDate})
                  ) as itemCnt
        <if test='rankType == "1"'>
            <if test='liveCnt != 0'>
                ,(select round(fan_point) from rd_data.tb_ranking_fan_live where date_format(ranking_date,'%Y.%m.%d') = #{sDate}  and mem_no=a.mem_no) as rankPoint
            </if>
            <if test='liveCnt == "0"'>
                ,(select round(fan_point) from rd_data.tb_ranking_fan_day where date_format(ranking_date,'%Y.%m.%d') = #{sDate}  and mem_no=a.mem_no) as rankPoint
            </if>
        </if>
        <if test='rankType == "2"'>
            ,(select round(fan_point) from rd_data.tb_ranking_fan_week where mem_no = a.mem_no and date_format(ranking_date,'%Y.%m.%d') = #{sDate}) as rankPoint
        </if>
        <if test='rankType == "3"'>
            ,(select round(fan_point) from rd_data.tb_ranking_fan_month where mem_no = a.mem_no and date_format(ranking_date,'%Y.%m.%d') = #{sDate}) as rankPoint
        </if>
         from rd_data.tb_member_broadcast_listening a
        where a.mem_no=#{mem_no}
          and date_format(a.end_date,'%Y.%m.%d') <![CDATA[>=]]> #{sDate}
          and date_format(a.end_date,'%Y.%m.%d') <![CDATA[<=]]> #{eDate}
    </select>



</mapper>