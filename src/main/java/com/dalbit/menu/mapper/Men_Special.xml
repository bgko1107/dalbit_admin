<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.menu.dao.Men_SpecialDao" >

    <select id="summary" parameterType="com.dalbit.menu.vo.SpecialSummaryVo" resultType="com.dalbit.menu.vo.SpecialSummaryVo">
        /* Men_Special.xml - summary */
        select
        (select
        count(*)
        from rd_admin.tb_req_special_dj redj
        inner join rd_data.tb_member_basic mem
        on redj.mem_no = mem.mem_no
        and concat(#{select_year}, #{select_month}) = DATE_FORMAT(redj.reg_date, '%Y%m')
        where redj.state <![CDATA[<>]]> 2
        ) as requestDal
        , (select
        count(*)
        from rd_admin.tb_special_dj dj
        inner join rd_data.tb_member_basic mem
        on dj.mem_no = mem.mem_no
        <where>
            <if test='select_year != null and select_year != ""' >
                dj.select_year = #{select_year}
            </if>
            <if test='select_month != null and select_month != ""' >
                and dj.select_month = #{select_month}
            </if>
        </where>
        ) as approveDal
    </select>

    <sql id="reqSpecial">
        <if test='txt_search != null and txt_search != ""'>
            <choose>
                <when test='searchType == "1"'>
                    and dj.mem_no like concat('%', #{txt_search}, '%')
                </when>
                <when test='searchType == "2"'>
                    and basic.mem_id like concat('%', #{txt_search}, '%')
                </when>
                <when test='searchType == "3"'>
                    and basic.mem_nick like concat('%', #{txt_search}, '%')
                </when>
                <when test='searchType == "4"'>
                    and dj.mem_phone like concat('%', #{txt_search}, '%')
                </when>
                <otherwise>
                    and (dj.mem_no like concat('%', #{txt_search}, '%')
                    or basic.mem_id like concat('%', #{txt_search}, '%')
                    or basic.mem_nick like concat('%', #{txt_search}, '%')
                    or dj.mem_phone like concat('%', #{txt_search}, '%'))
                </otherwise>
            </choose>
        </if>
    </sql>

    <select id="getReqSpecialList" parameterType="com.dalbit.menu.vo.SpecialReqVo" resultType="com.dalbit.menu.vo.SpecialReqVo">
        /* Men_Special.xml - getReqSpecialList */
        select
        *
        from (
        select
        dj.idx as idx
        , dj.mem_no as mem_no
        , dj.mem_name as mem_name
        , dj.mem_phone as mem_phone
        , dj.title as title
        , dj.reg_date as reg_date
        , dj.contents as contents
        , dj.broadcast_time1 as broadcast_time1
        , dj.broadcast_time2 as broadcast_time2
        , dj.state as state
        , dj.op_name as op_name
        , dj.last_upd_date as last_upd_date
        , profile.specialdj_badge as specialdj_badge
        , basic.mem_id as mem_id
        , basic.mem_nick as mem_nick
        , basic.mem_birth_year
        , basic.mem_birth_month
        , basic.mem_birth_day
        --                 , profile.image_profile  as image_profile
        , @RNUM := @RNUM + 1 as rowNum
        , ifnull((select TRUNCATE(ifnull(sum(airtime), 0) / 3600, 0)
        from rd_data.tb_broadcast_room room
        where mem_no = basic.mem_no
        and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00')<![CDATA[<=]]>start_date
        and start_date<![CDATA[<=]]>DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) airTime
        , ifnull((select count(*)
        from rd_data.tb_broadcast_room room
        where mem_no = basic.mem_no
        and 3600<![CDATA[<=]]>airtime
        and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00')<![CDATA[<=]]>start_date
        and start_date<![CDATA[<=]]>DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) broadcastCnt
        , ifnull((select count(*)
        from rd_data.tb_broadcast_room_good good
        where dj_mem_no = basic.mem_no
        and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00')<![CDATA[<=]]>last_upd_date
        and last_upd_date<![CDATA[<=]]>DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) goodCnt
        , ifnull((select count(*)
        from rd_data.tb_member_fanstar
        where mem_no_star = basic.mem_no), 0) fanCnt
        , ifnull((select count(*)
        from rd_data.tb_member_broadcast_listening
        where dj_mem_no = basic.mem_no
        and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00')<![CDATA[<=]]>last_upd_date
        and last_upd_date<![CDATA[<=]]>DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) allListenCnt
        , ifnull((select count(distinct listen.mem_no)
        from rd_data.tb_member_broadcast_listening listen
        where dj_mem_no = basic.mem_no
        and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00')<![CDATA[<=]]>last_upd_date
        and last_upd_date<![CDATA[<=]]>DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) listenCnt
        , ifnull((select count(*)
        from rd_data.tb_member_report report
        where reported_mem_no = basic.mem_no
        and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00')<![CDATA[<=]]>report.reg_date
        and report.reg_date<![CDATA[<=]]>DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) reportCnt
        , ifnull((select sum(gold)
        from rd_data.tb_member_wallet_gold gold
        where gold.mem_no = basic.mem_no
        and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00')<![CDATA[<=]]>last_upd_date
        and last_upd_date<![CDATA[<=]]>DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) receiveStar
        from rd_admin.tb_req_special_dj dj
        , rd_data.tb_member_profile profile
        , rd_data.tb_member_basic basic
        , rd_admin.tb_req_special_dj_manage manage
        , (select @RNUM := 0) r
        where basic.mem_no = dj.mem_no
        and profile.mem_no = dj.mem_no
        and basic.mem_no = profile.mem_no
        and dj.state <![CDATA[<>]]> 2
        and concat(#{select_year}, #{select_month}) = DATE_FORMAT(dj.reg_date, '%Y%m')
        and manage.select_year = #{select_year}
        and manage.select_month = #{select_month}
        <include refid="reqSpecial" />
        order by idx desc
        ) a
        limit #{pageStart}, #{pageCnt}
    </select>

    <select id="getReqSpecialListCnt" parameterType="com.dalbit.menu.vo.SpecialReqVo" resultType="integer">
        /* Men_Special.xml - getReqSpecialListCnt */
        select
        count(*)
        from rd_admin.tb_req_special_dj dj
        , rd_data.tb_member_basic basic
        where basic.mem_no = dj.mem_no
        and dj.state <![CDATA[<>]]> 2
        and concat(#{select_year}, #{select_month}) = DATE_FORMAT(dj.reg_date, '%Y%m')
        <include refid="reqSpecial" />
    </select>

    <select id="getReqSpecialDetail" parameterType="com.dalbit.menu.vo.SpecialReqVo" resultType="com.dalbit.menu.vo.SpecialReqVo">
        /* Men_Special.xml - getReqSpecialDetail */
        select
          idx
          , mem_no
          , mem_name
          , mem_phone
          , title
          , reg_date
          , op_name
          , last_upd_date
          , contents
          , broadcast_time1
          , broadcast_time2
          , state
        from rd_admin.tb_req_special_dj
        where idx = #{idx}
    </select>

    <insert id="reqOk" parameterType="com.dalbit.menu.vo.SpecialReqVo">
        /* Men_Special.xml - reqOk */
        insert into
          rd_admin.tb_special_dj (req_idx, mem_no, reg_date, op_name, is_force, `order`, select_year, select_month)
        values
        (#{idx}, #{mem_no}, current_timestamp(), #{op_name}, #{is_force}, (select ifnull(max(`order`), 0 ) + 1 from rd_admin.tb_special_dj dj), #{select_year}, #{select_month})
    </insert>

    <insert id="opLastUpdDate" parameterType="com.dalbit.menu.vo.SpecialReqVo">
        /* Men_Special.xml - opLastUpdDate*/
        update rd_admin.tb_req_special_dj
        set last_upd_date = now()
        where mem_no = #{mem_no}
    </insert>

    <update id="reqOkUpdate" parameterType="com.dalbit.menu.vo.SpecialReqVo">
        /* Men_Special.xml - reqOkUpdate */
      update rd_admin.tb_req_special_dj
      set state = #{state}
        , op_name=#{op_name}
        , last_upd_date = now()
      where idx = #{idx}
    </update>

    <update id="profileUpdate" parameterType="com.dalbit.menu.vo.SpecialReqVo">
        /* Men_Special.xml - profileUpdate */
        update rd_data.tb_member_profile
        set specialdj_badge = #{specialdj_badge}
        where mem_no = #{mem_no}
    </update>


    <sql id="special">
        <where>
            <if test='select_year != null and select_year != ""' >
                dj.select_year = #{select_year}
            </if>
            <if test='select_month != null and select_month != ""' >
                and dj.select_month = #{select_month}
            </if>
        </where>
        <if test='txt_search != null and txt_search != ""'>
            <choose>
                <when test='searchType == "1"'>
                    and dj.mem_no like concat('%', #{txt_search}, '%')
                </when>
                <when test='searchType == "2"'>
                    and basic.mem_id like concat('%', #{txt_search}, '%')
                </when>
                <when test='searchType == "3"'>
                    and basic.mem_nick like concat('%', #{txt_search}, '%')
                </when>
                <when test='searchType == "4"'>
                    and redj.mem_phone like concat('%', #{txt_search}, '%')
                </when>
                <otherwise>
                    and (dj.mem_no like concat('%', #{txt_search}, '%')
                    or basic.mem_id like concat('%', #{txt_search}, '%')
                    or basic.mem_nick like concat('%', #{txt_search}, '%')
                    or redj.mem_phone like concat('%', #{txt_search}, '%'))
                </otherwise>
            </choose>
        </if>
        order by `order` asc, dj.reg_date desc
    </sql>

    <select id="getSpecialList" parameterType="com.dalbit.menu.vo.SpecialVo" resultType="com.dalbit.menu.vo.SpecialVo">
        /* Men_Special.xml - getSpecialList */
        select *
        from (
        select
        @RNUM := @RNUM + 1 as rowNum,
        dj.req_idx         as req_idx,
        dj.mem_no          as mem_no,
        dj.reg_date        as reg_date,
        dj.is_force        as is_force,
        dj.`order`         as `order`,
        dj.op_name         as op_name,
        basic.mem_id       as mem_id,
        basic.mem_userid   as mem_userid,
        basic.mem_nick     as mem_nick,
        redj.mem_phone     as mem_phone,
        lev.level          as `level`,
        lev.grade          as grade,
        pro.image_profile  as image_profile,
        dj.select_year        as select_year,
        dj.select_month       as select_month,
        (select COUNT(*) from rd_data.tb_broadcast_room_live_list WHERE mem_no = dj.mem_no AND state <![CDATA[<]]> 4)  as onAir,
        (select COUNT(*) from rd_data.tb_member_fanstar WHERE mem_no_star= dj.mem_no) as fanCnt,
        (select ifnull(sum(airtime), 0) from rd_data.tb_member_broadcast_broadcasting WHERE mem_no= dj.mem_no) AS airTime,
        (select ifnull(sum(gold), 0) from rd_data.tb_member_broadcast_broadcasting WHERE mem_no= dj.mem_no) AS giftedRuby,
        (select ifnull(sum(good), 0) from rd_data.tb_member_broadcast_broadcasting WHERE mem_no= dj.mem_no) AS likeCnt,
        (SELECT
        count(distinct(DATE( last_upd_date )))
        FROM rd_data.tb_member_broadcast_broadcasting
        WHERE mem_no = dj.mem_no AND last_upd_date between SUBDATE(NOW(), INTERVAL 3 MONTH) AND NOW()) as broadcastCnt,
        (select count(*) from rd_data.tb_member_report WHERE mem_no = dj.mem_no and op_code in (3,4,5,6) ) as reportCnt
        ,basic.mem_birth_year
        ,basic.mem_birth_month
        ,basic.mem_birth_day
        from rd_admin.tb_special_dj dj
        inner join rd_data.tb_member_basic basic on dj.mem_no = basic.mem_no
        inner join rd_data.tb_member_profile pro on dj.mem_no = pro.mem_no
        inner join rd_data.tb_member_level lev on dj.mem_no = lev.mem_no
        left join rd_admin.tb_req_special_dj redj on dj.mem_no = redj.mem_no and dj.req_idx = redj.idx
        , (select @RNUM := 0) r
        <include refid="special"/>
        ) a
        where rowNum between #{searchStartNo, jdbcType=INTEGER} and #{searchEndNo, jdbcType=INTEGER}
    </select>

    <select id="getSpecialListCnt" parameterType="com.dalbit.menu.vo.SpecialVo" resultType="integer">
        /* Men_Special.xml - getSpecialListCnt */
        select
        count(*)
        from rd_admin.tb_special_dj dj
        inner join rd_data.tb_member_basic basic on dj.mem_no = basic.mem_no
        left join rd_admin.tb_req_special_dj redj on dj.mem_no = redj.mem_no and dj.req_idx = redj.idx
        <include refid="special"/>
    </select>

    <select id="checkSpecialDjCnt" parameterType="com.dalbit.menu.vo.SpecialVo" resultType="integer">
        /* Men_Special.xml - checkSpecialDjCnt */
        select
        count(*)
        from (
        <include refid="special"/>
        ) a
        where a.mem_no = #{mem_no}
        and a.select_year = #{select_year}
        and a.select_month = #{select_month}
    </select>

    <select id="getSpecialDetail" parameterType="com.dalbit.menu.vo.SpecialVo" resultType="com.dalbit.menu.vo.SpecialVo">
        /* Men_Special.xml - getSpecialDetail */
        select
          dj.req_idx as req_idx
          , dj.mem_no as mem_no
          , dj.reg_date as reg_date
          , dj.is_force as is_force
          , dj.op_name as op_name
          , redj.title as title
          , redj.contents as contents
          , redj.reg_date as request_date
          , dj.select_year as select_year
          , dj.select_month as select_month
        from
          rd_admin.tb_special_dj dj
          left join rd_admin.tb_req_special_dj redj on #{req_idx} = redj.idx and dj.req_idx = redj.idx and dj.mem_no = #{mem_no}
        where dj.mem_no = #{mem_no}
          and dj.select_year = #{select_year}
          and dj.select_month = #{select_month}
    </select>

    <delete id="reqCancel" parameterType="com.dalbit.menu.vo.SpecialVo">
        /* Men_Special.xml - reqCancel */
        delete
        from rd_admin.tb_special_dj
        where mem_no = #{mem_no}
          and select_year = #{select_year}
          and select_month = #{select_month}
    </delete>

    <update id="updateOrder" parameterType="com.dalbit.menu.vo.SpecialDjOrderVo">
        /* Men_Special.xml - updateOrder */
        update rd_admin.tb_special_dj
        set `order` = #{order}
        where mem_no = #{mem_no}
    </update>

    <select id="selectManageInfo" parameterType="com.dalbit.menu.vo.SpecialDjManageVo" resultType="com.dalbit.menu.vo.SpecialDjManageVo">
        /* Men_Special.xml - selectManageInfo */
        select
            idx
            , title
            , select_year
            , select_month
            , DATE_FORMAT(req_start_date, '%Y-%m-%d') req_start_date
            , DATE_FORMAT(req_end_date, '%Y-%m-%d') req_end_date
            , DATE_FORMAT(condition_start_date, '%Y-%m-%d') condition_start_date
            , DATE_FORMAT(condition_end_date, '%Y-%m-%d') condition_end_date
            , condition_code1
            , condition_data1
            , condition_code2
            , condition_data2
            , condition_code3
            , condition_data3
            , is_view
            , platform
            , pc_image_url
            , mobile_image_url
            , DATE_FORMAT(reg_date, '%Y-%m-%d %H:%i:%s') reg_date
            , op_name
            , DATE_FORMAT(last_upd_date, '%Y-%m-%d %H:%i:%s') last_upd_date
            , last_op_name
        from rd_admin.tb_req_special_dj_manage
        where select_year = #{select_year}
            and select_month = #{select_month}
    </select>

    <insert id="insertManageInfo" parameterType="com.dalbit.menu.vo.SpecialDjManageVo">
        /* Men_Special.xml - insertManageInfo */
        insert into rd_admin.tb_req_special_dj_manage(
            title
            , select_year
            , select_month
            , req_start_date
            , req_end_date
            , condition_start_date
            , condition_end_date
            , condition_code1
            , condition_data1
            , condition_code2
            , condition_data2
            , condition_code3
            , condition_data3
            , is_view
            , platform
            , pc_image_url
            , mobile_image_url
            , reg_date
            , op_name
        ) values (
            #{title}
            , #{select_year}
            , #{select_month}
            , #{req_start_date}
            , #{req_end_date}
            , #{condition_start_date}
            , #{condition_end_date}
            , #{condition_code1}
            , #{condition_data1}
            , #{condition_code2}
            , #{condition_data2}
            , #{condition_code3}
            , #{condition_data3}
            , #{is_view}
            , #{platform}
            , #{pc_image_url}
            , #{mobile_image_url}
            , now()
            , #{op_name}
        )
    </insert>

    <update id="updateManageInfo" parameterType="com.dalbit.menu.vo.SpecialDjManageVo">
        /* Men_Special.xml - updateManageInfo */
        update rd_admin.tb_req_special_dj_manage
        set title = #{title}
            , req_start_date = #{req_start_date}
            , req_end_date = #{req_end_date}
            , condition_start_date = #{condition_start_date}
            , condition_end_date = #{condition_end_date}
            , condition_code1 = #{condition_code1}
            , condition_data1 = #{condition_data1}
            , condition_code2 = #{condition_code2}
            , condition_data2 = #{condition_data2}
            , condition_code3 = #{condition_code3}
            , condition_data3 = #{condition_data3}
            , is_view = #{is_view}
            , platform = #{platform}
            , pc_image_url = #{pc_image_url}
            , mobile_image_url = #{mobile_image_url}
            , last_upd_date = now()
            , last_op_name = #{op_name}
        where select_year = #{select_year}
            and select_month = #{select_month}
    </update>
</mapper>