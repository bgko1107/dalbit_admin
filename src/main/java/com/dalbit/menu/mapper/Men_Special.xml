<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.menu.dao.Men_SpecialDao" >

    <select id="summary" parameterType="com.dalbit.menu.vo.SpecialSummaryVo" resultType="com.dalbit.menu.vo.SpecialSummaryVo">
        select
        (select count(*) from rd_admin.tb_req_special_dj redj) as requestDal
        , (select count(*) from rd_admin.tb_special_dj dj) as approveDal
    </select>

    <sql id="reqSpecial">
        select
          dj.idx as idx
        , dj.mem_no as mem_no
        , dj.mem_name as mem_name
        , dj.mem_phone as mem_phone
        , dj.title as title
        , dj.reg_date as reg_date
        , dj.contents as contents
        , dj.state as state
        , dj.op_name as op_name
        , dj.last_upd_date as last_upd_date
        , profile.specialdj_badge as specialdj_badge
        , basic.mem_id
        , basic.mem_nick
        , @RNUM := @RNUM + 1 as rowNum
        from rd_admin.tb_req_special_dj dj
            , rd_data.tb_member_profile profile
            , rd_data.tb_member_basic basic
            , (select @RNUM := 0) r
        where basic.mem_no = dj.mem_no
        and profile.mem_no = dj.mem_no
        and basic.mem_no = profile.mem_no
        <if test='txt_search != null and txt_search != ""'>
          <choose>
              <when test='searchType == "1"'>
                  and dj.mem_no like concat('%', #{txt_search}, '%')
              </when>
              <when test='searchType == "2"'>
                  and basic.mem_id like concat('%', #{txt_search}, '%')
              </when>
              <when test='searchType == "3"'>
                  and basic.mem_nick like concat('%', #{txt_search}, '%')
              </when>
              <when test='searchType == "4"'>
                  and dj.mem_phone like concat('%', #{txt_search}, '%')
              </when>
              <otherwise>
                  and (dj.mem_no like concat('%', #{txt_search}, '%')
                  or basic.mem_id like concat('%', #{txt_search}, '%')
                  or basic.mem_nick like concat('%', #{txt_search}, '%')
                  or dj.mem_phone like concat('%', #{txt_search}, '%'))
              </otherwise>
          </choose>
        </if>
        order by idx desc
    </sql>

    <select id="getReqSpecialList" parameterType="com.dalbit.menu.vo.SpecialReqVo" resultType="com.dalbit.menu.vo.SpecialReqVo">
        /* Men_Special.xml - getReqSpecialList */
        <include refid="reqSpecial"/>
    </select>

    <select id="getReqSpecialListCnt" parameterType="com.dalbit.menu.vo.SpecialReqVo" resultType="integer">
        /* Men_Special.xml - getReqSpecialListCnt */
        select
          count(*)
        from (
            <include refid="reqSpecial"/>
        ) a
    </select>

    <select id="getReqSpecialDetail" parameterType="com.dalbit.menu.vo.SpecialReqVo" resultType="com.dalbit.menu.vo.SpecialReqVo">
        /* Men_Special.xml - getReqSpecialDetail */
        select
          idx
          , mem_no
          , mem_name
          , mem_phone
          , title
          , reg_date
          , op_name
          , last_upd_date
          , contents
          , state
        from rd_admin.tb_req_special_dj
        where idx = #{idx}
    </select>

    <insert id="reqOk" parameterType="com.dalbit.menu.vo.SpecialReqVo">
        /* Men_Special.xml - reqOk */
        insert into
          rd_admin.tb_special_dj (req_idx, mem_no, reg_date, op_name, is_force, `order`)
        values
        (#{idx}, #{mem_no}, current_timestamp(), #{op_name}, #{is_force}, (select ifnull(max(`order`), 0 ) + 1 from rd_admin.tb_special_dj dj))
    </insert>

    <update id="reqOkUpdate" parameterType="com.dalbit.menu.vo.SpecialReqVo">
        /* Men_Special.xml - reqOkUpdate */
      update rd_admin.tb_req_special_dj
      set state = #{state}
        , op_name=#{op_name}
      where idx = #{idx}
    </update>

    <update id="profileUpdate" parameterType="com.dalbit.menu.vo.SpecialReqVo">
        /* Men_Special.xml - profileUpdate */
        update rd_data.tb_member_profile
        set specialdj_badge = #{specialdj_badge}
        where mem_no = #{mem_no}
    </update>


    <sql id="special">
        select
            @RNUM := @RNUM + 1 as rowNum,
            dj.req_idx         as req_idx,
            dj.mem_no          as mem_no,
            dj.reg_date        as reg_date,
            dj.is_force        as is_force,
            dj.`order`         as `order`,
            dj.op_name         as op_name,
            basic.mem_id       as mem_id,
            basic.mem_nick     as mem_nick,
            lev.level          as `level`,
            lev.grade          as grade,
            pro.image_profile  as image_profile,
            (select count(*) from rd_data.tb_broadcast_room_member where auth = 3 and state = 1 and mem_no = dj.mem_no) onAir,
            (select count(*) from rd_data.tb_member_fanstar where mem_no_star = dj.mem_no) fanCnt,
            (select sum(airtime) from rd_data.tb_broadcast_room  where mem_no = dj.mem_no) airTime,
            (select sum(gift_ruby) from rd_data.tb_member_broadcast_listening where dj_mem_no = dj.mem_no) giftedRuby,
            (select count(*) from rd_data.tb_broadcast_room_good where dj_mem_no = dj.mem_no) likeCnt
        from rd_admin.tb_special_dj dj,
            rd_data.tb_member_basic basic,
            rd_data.tb_member_profile pro,
            rd_data.tb_member_level lev,
            (select @RNUM := 0) r
        where dj.mem_no = basic.mem_no
            and basic.mem_no = pro.mem_no
            and basic.mem_no = lev.mem_no
        <if test='txt_search != null and txt_search != ""'>
            <choose>
                <when test='searchType == "1"'>
                    and dj.mem_no like concat('%', #{txt_search}, '%')
                </when>
                <when test='searchType == "2"'>
                    and basic.mem_id like concat('%', #{txt_search}, '%')
                </when>
                <when test='searchType == "3"'>
                    and basic.mem_nick like concat('%', #{txt_search}, '%')
                </when>
                <when test='searchType == "4"'>
                    and basic.mem_phone like concat('%', #{txt_search}, '%')
                </when>
                <otherwise>
                    and (dj.mem_no like concat('%', #{txt_search}, '%')
                    or basic.mem_id like concat('%', #{txt_search}, '%')
                    or basic.mem_nick like concat('%', #{txt_search}, '%')
                    or basic.mem_phone like concat('%', #{txt_search}, '%'))
                </otherwise>
            </choose>
        </if>
        order by `order` asc, reg_date desc
    </sql>

    <select id="getSpecialList" parameterType="com.dalbit.menu.vo.SpecialVo" resultType="com.dalbit.menu.vo.SpecialVo">
        /* Men_Special.xml - getSpecialList */
        select *
        from (
        <include refid="special"/>
        ) a
        where rowNum between #{searchStartNo, jdbcType=INTEGER} and #{searchEndNo, jdbcType=INTEGER}
    </select>

    <select id="getSpecialListCnt" parameterType="com.dalbit.menu.vo.SpecialVo" resultType="integer">
        /* Men_Special.xml - getSpecialListCnt */
        select
          count(*)
          from (
              <include refid="special"/>
          ) a
    </select>

    <select id="checkSpecialDjCnt" parameterType="com.dalbit.menu.vo.SpecialVo" resultType="integer">
        /* Men_Special.xml - getSpecialListCnt */
        select
        count(*)
        from (
        <include refid="special"/>
        ) a
        where a.mem_no = #{mem_no}
    </select>

    <select id="getSpecialDetail" parameterType="com.dalbit.menu.vo.SpecialVo" resultType="com.dalbit.menu.vo.SpecialVo">
        /* Men_Special.xml - getSpecialDetail */
        select
          dj.req_idx as req_idx
          , dj.mem_no as mem_no
          , dj.reg_date as reg_date
          , dj.is_force as is_force
          , dj.op_name as op_name
          , redj.title as title
          , redj.contents as contents
          , redj.reg_date as request_date
        from
          rd_admin.tb_special_dj dj
          left join rd_admin.tb_req_special_dj redj on #{req_idx} = redj.idx and dj.req_idx = redj.idx and dj.mem_no = #{mem_no}
        where dj.mem_no = #{mem_no}


    </select>

    <delete id="reqCancel" parameterType="com.dalbit.menu.vo.SpecialVo">
        /* Men_Special.xml - reqCancel */
        delete
        from rd_admin.tb_special_dj
        where mem_no = #{mem_no}
    </delete>

    <update id="updateOrder" parameterType="com.dalbit.menu.vo.SpecialDjOrderVo">
        /* Men_Special.xml - updateOrder */
        update rd_admin.tb_special_dj
        set `order` = #{order}
        where mem_no = #{mem_no}
    </update>
</mapper>