<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.customer.dao.Cus_SmsDao">

    <sql id="condition">
        <where>
            <if test = 'txt_startSel != null and txt_startSel != ""'>
                and report_time <![CDATA[>=]]> DATE_FORMAT(#{txt_startSel}, '%Y-%m-%d 00:00:00')
            </if>
            <if test = 'txt_endSel != null and txt_endSel != ""'>
                and report_time <![CDATA[<=]]> DATE_FORMAT(#{txt_endSel}, '%Y-%m-%d 23:59:59')
            </if>

            <if test = 'vxml_file != "-1"'>
                and vxml_file = #{vxml_file}
            </if>

            <if test = 'searchText != null and searchText != ""'>
                and send_phone like concat('%', #{searchText}, '%')
                or wap_info like concat('%', #{searchText}, '%')
                or dest_phone like concat('%', #{searchText}, '%')
                or msg_body like concat('%', #{searchText}, '%')
            </if>
        </where>
    </sql>

    <select id="getSmsList" parameterType="com.dalbit.customer.vo.SmsVo" resultType="com.dalbit.customer.vo.SmsVo">
        /* Cus_Sms.xml - getSmsList */
      select *
      from (
          select
              cmid
              , send_phone
              , wap_info
              , dest_phone
              , report_time
              , msg_body
              , vxml_file
              , @RNUM := @RNUM + 1 as rowNum
          from rd_data.hp_msg_hist_000000
          , (select @RNUM := 0) r
        <include refid="condition"/>
          order by report_time desc
      ) a
      where rowNum between #{searchStartNo, jdbcType=INTEGER} and #{searchEndNo, jdbcType=INTEGER}
    </select>

    <select id="getSmsListCnt" parameterType="com.dalbit.customer.vo.SmsVo" resultType="integer">
        /* Cus_Sms.xml - getSmsListCnt */
        select
          count(*)
          from (
          select
              cmid
              , send_phone
              , wap_info
              , dest_phone
              , report_time
              , msg_body
              , vxml_file
              from rd_data.hp_msg_hist_000000
        <include refid="condition"/>
        ) b
    </select>
</mapper>