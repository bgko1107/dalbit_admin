<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.money.dao.Mon_ItemDao" >

    <sql id="baseChangeItemList">
        select  @RNUM := @RNUM + 1 as rowNum
                ,DATE_FORMAT(a.last_upd_date, '%Y-%m-%d %h:%i:%s') as last_upd_date
                ,c.mem_no
                ,c.mem_userid
                ,c.mem_nick
                ,c.mem_sex
                ,c.inner
                ,(select grade From rd_data.tb_member_level where mem_no = a.mem_no) as mem_grade
                ,(select `level` From rd_data.tb_member_level where mem_no = a.mem_no) as mem_level
                ,(select count(*) from rd_data.tb_member_wallet_ruby where mem_no=a.mem_no and type=6) as changeCnt
                ,b.gold as gold
                ,a.ruby as ruby
                ,a.ruby_old as ruby_old
                ,b.gold_old as gold_old
                ,a.ruby_new as ruby_new
                ,b.gold_new as gold_new
           from rd_data.tb_member_wallet_ruby a join rd_data.tb_member_wallet_gold b on a.mem_no = b.mem_no
          inner join rd_data.tb_member_basic c on a.mem_no = c.mem_no
                ,(select @RNUM := 0) r
          where a.type=6 and b.type=1
            and a.last_upd_date = b.last_upd_date
            <if test='sDate != null and eDate != ""'>
                and DATE_FORMAT(a.last_upd_date, '%Y.%m.%d') >= #{sDate}
                and DATE_FORMAT(a.last_upd_date, '%Y.%m.%d') <![CDATA[<=]]> #{eDate}
            </if>

            <if test='search_value != null and search_value != ""'>
                <choose>
                    <when test="search_type == 'mem_no'">
                        and c.mem_no like CONCAT('%',#{search_value},'%')
                    </when>
                    <when test="search_type == 'user_id'">
                        and c.mem_userid like CONCAT('%',#{search_value},'%')
                    </when>
                    <when test="search_type == 'mem_nick'">
                        and c.mem_nick like CONCAT('%',#{search_value},'%')
                    </when>
                    <when test="search_type == 'mem_phone'">
                        and c.mem_phone like CONCAT('%',#{search_value},'%')
                    </when>
                    <otherwise>
                        and (
                        c.mem_no like CONCAT('%',#{search_value},'%')
                        or c.mem_userid like CONCAT('%',#{search_value},'%')
                        or c.mem_nick like CONCAT('%',#{search_value},'%')
                        or c.mem_phone like CONCAT('%',#{search_value},'%')
                        )
                    </otherwise>
                </choose>
            </if>

            <if test='search_testId == 1'>
                and c.inner = 0
            </if>

        order by a.last_upd_date desc
    </sql>


    <select id="selectChangeItemCnt" parameterType="com.dalbit.money.vo.Mon_ItemInputVo" resultType="int">
        /* Mon_Item.xml - selectChangeItemCnt */
        select count(*)
        from(
            <include refid="baseChangeItemList"/>
        )a
    </select>

    <select id="selectChangeItemList" parameterType="com.dalbit.money.vo.Mon_ItemInputVo" resultType="com.dalbit.money.vo.Mon_ItemOutputVo">
        /* Mon_Item.xml - selectChangeItemList */
        select *
        from(
            <include refid="baseChangeItemList"/>
        ) list
        where list.rowNum between #{searchStartNo, jdbcType=INTEGER} and #{searchEndNo, jdbcType=INTEGER}
    </select>

</mapper>